<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Team - Graduation Project</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?display=swap&family=Be+Vietnam+Pro:wght@400;500;700;900&family=Noto+Sans+Arabic:wght@400;500;700;900" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: "Noto Sans Arabic", "Be Vietnam Pro", sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #000000; /* Black */
            color: #f3f4f6; /* Tailwind gray-100 */
        }
        .dark header, .dark footer, .dark .modal-content, .dark #mobile-menu {
            background-color: #111827; /* Tailwind gray-900 (very dark gray) */
            border-color: #1f2937; /* Tailwind gray-800 */
        }
        .dark .content-section, .dark .layout-content-container, .dark #create-event-form-container, 
        .dark #event-details-content, .dark #event-comments-list, .dark #add-comment-form-container,
        .dark #current-user-profile-form-container { 
            background-color: #111827; 
        }
         .dark .team-member-card, .dark .bg-white { 
            background-color: #1f2937; 
            border-color: #374151; 
        }

        .dark .text-\[\#0e141b\], .dark .text-\[\#101418\], .dark .text-black, .dark .text-gray-800, .dark .text-gray-700 {
            color: #f3f4f6; 
        }
        .dark .text-\[\#5c718a\], .dark .text-slate-600, .dark .text-gray-600, .dark .text-gray-500, .dark .text-gray-400, .dark .text-\[\#4e7097\] {
            color: #d1d5db; 
        }
        .dark .border-\[\#d4dbe2\], .dark .border-gray-300, .dark .border-gray-200 {
            border-color: #374151; 
        }
        .dark .bg-gray-50, .dark .bg-slate-50 {
            background-color: #000000; 
        }
         .dark .bg-gray-100 {
            background-color: #111827; 
         }
        .dark .placeholder\:text-\[\#5c718a\]::placeholder {
            color: #9ca3af; 
        }
        .dark .form-input {
            background-color: #1f2937; 
            border-color: #374151; 
            color: #f3f4f6;
        }
        .dark .form-input:focus {
            border-color: #1978e5;
        }
        .dark .nav-link.text-\[\#0e141b\] {
            color: #f3f4f6;
        }
        .dark .nav-link.text-\[\#0e141b\]:hover {
            color: #3b82f6; 
        }
        .dark .nav-link.text-\[\#4e7097\] {
            color: #d1d5db;
        }
         .dark .nav-link.text-\[\#4e7097\]:hover {
            color: #3b82f6;
         }
        .dark #create-event-btn { 
            background-color: #374151; 
            color: #f3f4f6;
        }
        .dark #create-event-btn:hover { 
            background-color: #4b5563; 
        }
        .dark .form-button.bg-gray-300 {
            background-color: #4b5563; 
            color: #f3f4f6;
        }
        .dark .form-button.bg-gray-300:hover {
            background-color: #374151; 
        }


        /* Helper class to hide sections */
        .hidden-section {
            display: none !important;
        }
        /* Basic styling for active nav link */
        .nav-active {
            font-weight: bold;
            color: #1978e5; /* Tailwind blue-600 */
        }
        .dark .nav-active {
            color: #60a5fa; /* Lighter blue for dark mode active */
        }
        /* Custom modal styles */
        .modal {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .modal-close-btn {
            margin-top: 15px;
            padding: 8px 16px;
            background-color: #1978e5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        /* Ensure images from Supabase fit well */
        .event-image, .profile-avatar {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }
        .avatar-preview { /* Kept for profile avatar */
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
        }
        .event-image-preview-item { /* For multiple event image previews */
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 2px solid transparent;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .event-image-preview-item.selected-main {
            border-color: #1978e5; /* Tailwind blue-600 */
            box-shadow: 0 0 0 2px #1978e5;
        }
        .dark .event-image-preview-item.selected-main {
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px #60a5fa;
        }


        .header-logo {
            height: 40px; /* Adjust as needed */
            width: auto;
            object-fit: contain; /* Ensures the logo is not distorted */
        }
        .reaction-btn.selected span { /* Style the span (emoji) when selected */
            transform: scale(1.2);
            filter: saturate(2); /* Make emoji more vibrant */
        }
        .reaction-btn span {
            transition: transform 0.1s ease-in-out, filter 0.1s ease-in-out;
            font-size: 1.25rem; /* Larger emoji */
             display: inline-block; /* Needed for transform to work consistently */
        }
        .comment-actions button {
            margin-left: 5px;
            padding: 2px 5px;
            font-size: 0.75rem; /* 12px */
            border-radius: 4px;
        }
        .edit-comment-area {
            width: 100%;
        }
        .team-member-card {
            background-color: #f9fafb; 
             border: 1px solid #e5e7eb; 
        }
        .dark .team-member-card {
            background-color: #1f2937; /* Tailwind gray-800 for cards in dark mode */
            border-color: #374151; /* Tailwind gray-700 for card borders in dark mode */
        }
         /* Animation for cards */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .team-member-card {
            animation-name: slideInUp;
            animation-duration: 0.5s; /* Control speed */
            animation-fill-mode: forwards; /* Keep state after animation */
            animation-timing-function: ease-out;
            opacity: 0; /* Start hidden */
            animation-delay: var(--animation-delay, 0s); /* Customizable delay */
        }

        /* Mobile menu styles (basic) */
        #mobile-menu-button-container { 
            display: none; 
        }
        #mobile-menu {
            /* REMOVED display: none; from here. It's controlled by hidden-section and md:hidden */
        }

        @media (max-width: 768px) { /* md breakpoint in Tailwind */
            #desktop-nav {
                display: none;
            }
            #mobile-menu-button-container {
                display: flex; 
            }
        }
        .social-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        .dark .social-icon {
            color: #9ca3af; /* Tailwind gray-400 for dark mode icons */
        }
        .dark .social-icon:hover {
            color: #60a5fa; /* Lighter blue for hover in dark mode */
        }
        .social-icon:hover {
            color: #1978e5; /* Tailwind blue-600 for light mode hover */
        }
         /* Event details gallery */
        .event-gallery-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .event-gallery-image:hover, .event-gallery-image.active-gallery-thumb {
            border-color: #1978e5;
        }
        .dark .event-gallery-image:hover, .dark .event-gallery-image.active-gallery-thumb {
            border-color: #60a5fa;
        }
        #event-details-main-image {
            max-height: 450px; /* Control max height of main image */
        }
    </style>
</head>
<body class="bg-slate-50">
    <div class="relative flex size-full min-h-screen flex-col group/design-root overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#e7edf3] px-4 sm:px-10 py-3 bg-white shadow-sm">
                <div class="flex-1"> <a href="#" class="nav-link flex items-center gap-2 sm:gap-4 text-[#0e141b]" data-target="home">
                        <div class="size-8 sm:size-10 flex items-center justify-center"> <img src="https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/drive/Flash.png" alt="شعار فريق Flash" class="header-logo" onerror="this.onerror=null; this.src='https://placehold.co/40x40/768390/FFFFFF?text=F'; this.alt='شعار فريق Flash الافتراضي'; console.error('Error loading team logo from Supabase. Ensure the URL is correct and the object is publicly accessible.')">
                        </div>
                        <h2 class="text-[#0e141b] text-lg sm:text-xl font-bold leading-tight tracking-[-0.015em]">فريق Flash</h2>
                    </a>
                </div>
                
                <nav id="desktop-nav" class="hidden md:flex md:flex-1 md:justify-center gap-4 lg:gap-8 items-center">
                    <a class="nav-link text-[#0e141b] text-sm font-medium leading-normal hover:text-[#1978e5]" href="#" data-target="home">الرئيسية</a>
                    <a class="nav-link text-[#0e141b] text-sm font-medium leading-normal hover:text-[#1978e5]" href="#" data-target="events">الفعاليات</a>
                    <a class="nav-link text-[#0e141b] text-sm font-medium leading-normal hover:text-[#1978e5]" href="#" data-target="profiles">الأعضاء</a>
                    <a id="my-profile-nav-link" class="nav-link text-[#0e141b] text-sm font-medium leading-normal hover:text-[#1978e5] hidden-section" href="#" data-target="my-profile-section">ملفي الشخصي</a>
                    <a class="nav-link text-[#0e141b] text-sm font-medium leading-normal hover:text-[#1978e5]" href="#" data-target="contact">اتصل بنا</a>
                </nav>

                <div id="mobile-menu-button-container" class="flex-1 justify-center md:hidden"> <button id="mobile-menu-button" class="p-2 rounded-md text-gray-600 hover:text-gray-800 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                        <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                        </svg>
                    </button>
                </div>

                <div class="flex flex-1 justify-end items-center gap-2 sm:gap-4"> <button id="theme-toggle-button" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden-section" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden-section" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.464 4.076a1 1 0 011.414 0l.707.707a1 1 0 11-1.414 1.414l-.707-.707a1 1 0 010-1.414zM10 16a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                    <div id="auth-links" class="flex items-center gap-2 sm:gap-4">
                        <button id="nav-login-btn" data-target="login" class="nav-link flex min-w-[70px] sm:min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 sm:h-10 px-3 sm:px-4 bg-[#1978e5] text-slate-50 text-xs sm:text-sm font-bold leading-normal tracking-[0.015em]">
                            <span class="truncate">تسجيل الدخول</span>
                        </button>
                         <button id="nav-signup-btn" data-target="signup" class="nav-link hidden-section flex min-w-[70px] sm:min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 sm:h-10 px-3 sm:px-4 border border-[#1978e5] text-[#1978e5] text-xs sm:text-sm font-bold leading-normal tracking-[0.015em]">
                            <span class="truncate">إنشاء حساب</span>
                        </button>
                    </div>
                     <div id="user-info" class="hidden-section items-center gap-2 sm:gap-3">
                        <img id="user-avatar-nav" src="https://placehold.co/32x32/E0E0E0/B0B0B0?text=U" alt="User Avatar" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover">
                        <span id="user-name-nav" class="hidden sm:block text-sm font-medium text-[#0e141b]"></span>
                        <button id="nav-logout-btn" class="flex min-w-[70px] sm:min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 sm:h-10 px-3 sm:px-4 bg-red-500 text-slate-50 text-xs sm:text-sm font-bold leading-normal tracking-[0.015em]">
                            <span class="truncate">تسجيل الخروج</span>
                        </button>
                    </div>
                </div>
            </header>
            <div id="mobile-menu" class="md:hidden bg-white shadow-lg py-2 hidden-section">
                <a class="block nav-link text-center text-[#0e141b] py-2 text-sm font-medium leading-normal hover:text-[#1978e5] dark:text-gray-200 dark:hover:text-blue-400" href="#" data-target="home">الرئيسية</a>
                <a class="block nav-link text-center text-[#0e141b] py-2 text-sm font-medium leading-normal hover:text-[#1978e5] dark:text-gray-200 dark:hover:text-blue-400" href="#" data-target="events">الفعاليات</a>
                <a class="block nav-link text-center text-[#0e141b] py-2 text-sm font-medium leading-normal hover:text-[#1978e5] dark:text-gray-200 dark:hover:text-blue-400" href="#" data-target="profiles">الأعضاء</a>
                <a id="my-profile-nav-link-mobile" class="block nav-link text-center text-[#0e141b] py-2 text-sm font-medium leading-normal hover:text-[#1978e5] hidden-section dark:text-gray-200 dark:hover:text-blue-400" href="#" data-target="my-profile-section">ملفي الشخصي</a>
                <a class="block nav-link text-center text-[#0e141b] py-2 text-sm font-medium leading-normal hover:text-[#1978e5] dark:text-gray-200 dark:hover:text-blue-400" href="#" data-target="contact">اتصل بنا</a>
            </div>


            <main class="flex-1">
                <section id="home" class="content-section px-5 md:px-20 lg:px-40 py-5">
                    <div class="layout-content-container flex flex-col max-w-[960px] mx-auto">
                        <div class="@container">
                            <div class="@[480px]:p-4">
                                <div class="flex min-h-[300px] sm:min-h-[480px] flex-col gap-6 bg-cover bg-center bg-no-repeat @[480px]:gap-8 @[480px]:rounded-lg items-center justify-center p-4" style='background-image: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.5)), url("https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/personal-image//MinaOmarMenaBakar.jpg");'>
                                    <div class="flex flex-col gap-2 text-center">
                                        <h1 class="text-white text-3xl sm:text-4xl font-black leading-tight tracking-[-0.033em] @[480px]:text-5xl @[480px]:font-black @[480px]:leading-tight @[480px]:tracking-[-0.033em]">
                                            فريق Flash
                                        </h1>
                                        <h2 class="text-white text-xs sm:text-sm font-normal leading-normal @[480px]:text-base @[480px]:font-normal @[480px]:leading-normal">
                                            نحن فريق نعمل على مشروع تخرجنا. هدفنا هو إنشاء حلول مبتكرة تحدث فرقاً.
                                        </h2>
                                    </div>
                                    <button data-target="events" class="nav-link flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 @[480px]:h-12 @[480px]:px-5 bg-[#1978e5] text-slate-50 text-sm font-bold leading-normal tracking-[0.015em] @[480px]:text-base @[480px]:font-bold @[480px]:leading-normal @[480px]:tracking-[0.015em]">
                                        <span class="truncate">اكتشف المزيد</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <h2 class="text-[#0e141b] text-xl sm:text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">من نحن</h2>
                        <p class="text-[#0e141b] text-sm sm:text-base font-normal leading-normal pb-3 pt-1 px-4">
"شرارة الإبداع، وسرعة الإنجاز! هنا فريق Flash، حيث تجتمع 15 عقلية هندسية لامعة، يوحدهم شغف لا حدود له بالابتكار. مهمتنا؟ تحويل الأفكار الجريئة إلى واقع ملموس يضيء المستقبل. استكشفوا معنا جزء من عالمنا الهندسي الذي نفتخر بوجوده لكم هنا."                        </p>
                        <h2 class="text-[#0e141b] text-xl sm:text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">مشروعنا</h2>
                        <p class="text-[#0e141b] text-sm sm:text-base font-normal leading-normal pb-3 pt-1 px-4">
انطلاقًا من شغف فريق Flash بالابتكار والتطوير، نقدم تصورًا لمشروع توزيع كهرباء لمبنى حديث (هنكتب المبني هنا ). يهدف هذا المشروع إلى تجاوز الطرق التقليدية في توزيع الطاقة، مع التركيز على دمج أحدث التقنيات لضمان الكفاءة، الاستدامة، الأمان، المرونة، وتقديم تجربة مستخدم لا مثيل لها.                        </p>
                        </div>
                </section>

                <section id="login" class="content-section hidden-section px-5 md:px-20 lg:px-40 py-5 flex justify-center items-center min-h-[calc(100vh-140px)]">
                    <div class="layout-content-container flex flex-col w-full max-w-md p-8 bg-white shadow-xl rounded-lg">
                        <h2 class="text-[#101418] tracking-light text-[28px] font-bold leading-tight text-center pb-6">مرحباً بعودتك</h2>
                        <form id="login-form">
                            <div class="mb-4">
                                <label class="block text-[#101418] text-base font-medium leading-normal pb-2" for="login-email">البريد الإلكتروني</label>
                                <input id="login-email" type="email" placeholder="أدخل بريدك الإلكتروني" required class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#101418] focus:outline-0 focus:ring-2 focus:ring-[#1978e5] border border-[#d4dbe2] bg-gray-50 focus:border-[#1978e5] h-14 placeholder:text-[#5c718a] p-[15px] text-base font-normal leading-normal"/>
                            </div>
                            <div class="mb-4">
                                <label class="block text-[#101418] text-base font-medium leading-normal pb-2" for="login-password">كلمة المرور</label>
                                <input id="login-password" type="password" placeholder="أدخل كلمة المرور" required class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#101418] focus:outline-0 focus:ring-2 focus:ring-[#1978e5] border border-[#d4dbe2] bg-gray-50 focus:border-[#1978e5] h-14 placeholder:text-[#5c718a] p-[15px] text-base font-normal leading-normal"/>
                            </div>
                            <div class="mb-6"> 
                                <label class="block text-[#101418] text-base font-medium leading-normal pb-2" for="login-admin-code">رمز المسؤول (اختياري)</label>
                                <input id="login-admin-code" type="text" placeholder="أدخل رمز المسؤول إن وجد" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#101418] focus:outline-0 focus:ring-2 focus:ring-[#1978e5] border border-[#d4dbe2] bg-gray-50 focus:border-[#1978e5] h-14 placeholder:text-[#5c718a] p-[15px] text-base font-normal leading-normal"/>
                            </div>
                            <button type="submit" class="flex w-full min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-4 bg-[#1978e5] text-slate-50 text-base font-bold leading-normal tracking-[0.015em] hover:bg-blue-700 transition-colors">
                                <span class="truncate">تسجيل الدخول</span>
                            </button>
                        </form>
                        <p class="text-[#5c718a] text-sm font-normal leading-normal pt-4 text-center">
                            ليس لديك حساب؟ <a href="#" data-target="signup" class="nav-link text-[#1978e5] hover:underline">أنشئ حساباً</a>
                        </p>
                         <p class="text-[#5c718a] text-sm font-normal leading-normal pt-2 text-center">
                            <a href="#" id="forgot-password-link" data-target="forgot-password-section" class="nav-link text-[#1978e5] hover:underline">هل نسيت كلمة المرور؟</a>
                        </p>
                    </div>
                </section>

                <section id="signup" class="content-section hidden-section px-5 md:px-20 lg:px-40 py-5 flex justify-center items-center min-h-[calc(100vh-140px)]">
                    <div class="layout-content-container flex flex-col w-full max-w-md p-8 bg-white shadow-xl rounded-lg">
                        <h2 class="text-[#101418] tracking-light text-[28px] font-bold leading-tight text-center pb-6">إنشاء حساب جديد</h2>
                        <form id="signup-form">
                            <div class="mb-4">
                                <label class="block text-[#101418] text-base font-medium leading-normal pb-2" for="signup-fullname">الاسم</label>
                                <input id="signup-fullname" type="text" placeholder="أدخل اسمك (سيستخدم كاسم كامل واسم مستخدم)" required class="form-input input-field"/>
                            </div>
                            <div class="mb-4">
                                <label class="block text-[#101418] text-base font-medium leading-normal pb-2" for="signup-email">البريد الإلكتروني</label>
                                <input id="signup-email" type="email" placeholder="أدخل بريدك الإلكتروني" required class="form-input input-field"/>
                            </div>
                            <div class="mb-4">
                                <label class="block text-[#101418] text-base font-medium leading-normal pb-2" for="signup-password">كلمة المرور</label>
                                <input id="signup-password" type="password" placeholder="اختر كلمة مرور قوية" required class="form-input input-field"/>
                            </div>
                             <div class="mb-4">
                                <label class="block text-[#101418] text-base font-medium leading-normal pb-2" for="signup-academic-id">الرقم الأكاديمي (اختياري)</label>
                                <input id="signup-academic-id" type="text" placeholder="أدخل رقمك الأكاديمي إن وجد" class="form-input input-field"/> </div>
                            <div class="mb-6">
                                <label class="block text-[#101418] text-base font-medium leading-normal pb-2" for="signup-admin-code-input">رمز المسؤول (اختياري)</label>
                                <input id="signup-admin-code-input" type="text" placeholder="أدخل رمز المسؤول إن وجد" class="form-input input-field"/>
                                <p class="text-xs text-gray-500 mt-1">سيتم تحديد دورك (admin/user) بناءً على هذا الرمز.</p>
                            </div>
                            <button type="submit" class="form-button w-full bg-[#1978e5] text-slate-50 hover:bg-blue-700">
                                <span class="truncate">إنشاء الحساب</span>
                            </button>
                        </form>
                        <p class="text-[#5c718a] text-sm font-normal leading-normal pt-4 text-center">
                            لديك حساب بالفعل؟ <a href="#" data-target="login" class="nav-link text-[#1978e5] hover:underline">سجل الدخول</a>
                        </p>
                    </div>
                </section>

                <section id="forgot-password-section" class="content-section hidden-section px-5 md:px-20 lg:px-40 py-5 flex justify-center items-center min-h-[calc(100vh-140px)]">
                    <div class="layout-content-container flex flex-col w-full max-w-md p-8 bg-white shadow-xl rounded-lg">
                        <h2 class="text-[#101418] tracking-light text-[28px] font-bold leading-tight text-center pb-6">إعادة تعيين كلمة المرور</h2>
                        <form id="forgot-password-form">
                            <div class="mb-4">
                                <label class="block text-[#101418] text-base font-medium leading-normal pb-2" for="forgot-password-email">البريد الإلكتروني</label>
                                <input id="forgot-password-email" type="email" placeholder="أدخل بريدك الإلكتروني المسجل" required class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#101418] focus:outline-0 focus:ring-2 focus:ring-[#1978e5] border border-[#d4dbe2] bg-gray-50 focus:border-[#1978e5] h-14 placeholder:text-[#5c718a] p-[15px] text-base font-normal leading-normal"/>
                            </div>
                            <button type="submit" class="flex w-full min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-4 bg-[#1978e5] text-slate-50 text-base font-bold leading-normal tracking-[0.015em] hover:bg-blue-700 transition-colors">
                                <span class="truncate">إرسال رابط إعادة التعيين</span>
                            </button>
                        </form>
                        <p class="text-[#5c718a] text-sm font-normal leading-normal pt-4 text-center">
                            تذكرت كلمة المرور؟ <a href="#" data-target="login" class="nav-link text-[#1978e5] hover:underline">سجل الدخول</a>
                        </p>
                    </div>
                </section>

                <section id="profiles" class="content-section hidden-section px-5 md:px-20 lg:px-40 py-5">
                    <div class="layout-content-container flex flex-col max-w-[960px] mx-auto">
                        <div class="flex flex-wrap justify-between items-center gap-3 p-4">
                            <p class="text-[#101418] tracking-light text-2xl sm:text-[32px] font-bold leading-tight min-w-72">أعضاء فريق Flash</p>
                        </div>
                                                
                        <div id="team-members-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 p-4">
                            <div class="text-center p-4 text-gray-500 col-span-full">جاري تحميل ملفات الفريق...</div>
                        </div>
                    </div>
                </section>

                <section id="my-profile-section" class="content-section hidden-section px-5 md:px-20 lg:px-40 py-5">
                     <div class="layout-content-container flex flex-col max-w-[960px] mx-auto">
                        <div id="current-user-profile-form-container" class="mb-8 p-6 bg-white rounded-lg shadow">
                            <h3 class="text-[#101418] text-xl font-bold leading-tight tracking-[-0.015em] mb-4">تحديث ملفك الشخصي</h3>
                            <form id="update-profile-form" class="space-y-4">
                                <div class="flex justify-center mb-4">
                                     <img id="update-avatar-preview" src="https://placehold.co/100x100/E0E0E0/B0B0B0?text=Avatar" alt="Avatar Preview" class="avatar-preview">
                                </div>
                                <div>
                                    <label for="update-avatar-file" class="block text-sm font-medium text-gray-700">الصورة الرمزية (ملف صورة)</label>
                                    <input type="file" id="update-avatar-file" name="avatarFile" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-[#1978e5] hover:file:bg-blue-100">
                                </div>
                                <div>
                                    <label for="update-full-name" class="block text-sm font-medium text-gray-700">الاسم الكامل</label>
                                    <input type="text" id="update-full-name" name="fullName" class="input-field mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                </div>
                                <div>
                                    <label for="update-user-name" class="block text-sm font-medium text-gray-700">اسم المستخدم</label>
                                    <input type="text" id="update-user-name" name="userName" class="input-field mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                </div>
                                <div>
                                    <label for="update-academic-id" class="block text-sm font-medium text-gray-700">الرقم الأكاديمي</label>
                                    <input type="text" id="update-academic-id" name="academicId" class="input-field mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">الدور</label>
                                    <p id="update-profile-role-display" class="mt-1 p-3 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100 text-gray-700"></p>
                                </div>
                                <button type="submit" class="form-button w-full bg-[#1978e5] text-slate-50 hover:bg-blue-700">تحديث الملف الشخصي</button>
                            </form>
                        </div>
                    </div>
                </section>

                <section id="events" class="content-section hidden-section px-5 md:px-20 lg:px-40 py-5">
                    <div class="layout-content-container flex flex-col max-w-[960px] mx-auto">
                        <div class="flex flex-wrap justify-between items-center gap-3 p-4">
                            <p class="text-[#101418] tracking-light text-2xl sm:text-[32px] font-bold leading-tight min-w-72">فعاليات المشروع</p>
                            <button id="create-event-btn" class="form-button bg-[#eaedf1] text-[#101418] hover:bg-gray-300 hidden-section"> <span class="truncate">إنشاء فعالية</span>
                            </button>
                        </div>

                        <div id="create-event-form-container" class="hidden-section p-6 bg-white rounded-lg shadow mb-8">
                            <h2 id="event-form-title" class="text-[#101418] text-2xl font-bold mb-4">إنشاء فعالية جديدة</h2>
                            
                            <div id="event-images-preview-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 mb-4">
                                </div>
                            <div class="mb-4">
                                <label for="event-image-files" class="block text-sm font-medium text-gray-700">صور الفعالية (حتى 10 صور)</label>
                                <input type="file" id="event-image-files" name="imageFiles" accept="image/*" multiple class="input-field mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-[#1978e5] hover:file:bg-blue-100">
                                <p class="text-xs text-gray-500 mt-1">اختر صورة واحدة لتكون الصورة الرئيسية للفعالية من خلال النقر عليها في المعاينة.</p>
                            </div>

                            <form id="create-event-form" class="space-y-4">
                                <div>
                                    <label for="event-title" class="block text-sm font-medium text-gray-700">عنوان الفعالية</label>
                                    <input type="text" id="event-title" name="title" required class="input-field mt-1 block w-full">
                                </div>
                                <div>
                                    <label for="event-description" class="block text-sm font-medium text-gray-700">وصف الفعالية</label>
                                    <textarea id="event-description" name="description" rows="3" required class="input-field mt-1 block w-full"></textarea>
                                </div>
                                <div>
                                    <label for="event-date" class="block text-sm font-medium text-gray-700">تاريخ الفعالية</label>
                                    <input type="date" id="event-date" name="event_date" required class="input-field mt-1 block w-full">
                                </div>
                                <div class="flex gap-4">
                                    <button type="submit" id="submit-event-form-btn" class="form-button flex-1 bg-[#1978e5] text-slate-50 hover:bg-blue-700">إنشاء</button>
                                    <button type="button" id="cancel-create-event-btn" class="form-button flex-1 bg-gray-300 text-gray-700 hover:bg-gray-400">إلغاء</button>
                                </div>
                            </form>
                        </div>

                        <h2 class="text-[#101418] text-xl sm:text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">الفعاليات القادمة</h2>
                        <div id="upcoming-events-list" class="p-4 space-y-6">
                            <div class="text-center p-4 text-gray-500 col-span-full">جاري تحميل الفعاليات القادمة...</div>
                        </div>

                        <h2 class="text-[#101418] text-xl sm:text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">الفعاليات السابقة</h2>
                        <div id="past-events-list" class="p-4 space-y-6">
                            <div class="text-center p-4 text-gray-500 col-span-full">جاري تحميل الفعاليات السابقة...</div>
                        </div>
                    </div>
                </section>

                <section id="event-details" class="content-section hidden-section px-5 md:px-20 lg:px-40 py-5">
                    <div class="layout-content-container flex flex-col max-w-[960px] mx-auto">
                        <div class="flex flex-wrap gap-2 p-4">
                            <a href="#" class="nav-link text-[#4e7097] text-base font-medium leading-normal" data-target="events">الفعاليات</a>
                            <span class="text-[#4e7097] text-base font-medium leading-normal">/</span>
                            <span id="event-details-breadcrumb" class="text-[#0e141b] text-base font-medium leading-normal">تفاصيل الفعالية</span>
                        </div>
                        <div id="event-details-content" class="bg-white p-6 rounded-lg shadow-md">
                            <img id="event-details-main-image" src="https://placehold.co/800x400/64748B/E0E7FF?text=Event+Image" alt="صورة الفعالية الرئيسية" class="w-full h-auto object-cover rounded-lg mb-6 shadow">
                            <div id="event-details-gallery" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 mb-4">
                                </div>
                            <div class="text-center p-4 text-gray-500">جاري تحميل تفاصيل الفعالية...</div>
                        </div>

                        <h2 class="text-[#0e141b] text-xl sm:text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">التعليقات</h2>
                        <div id="event-comments-list" class="space-y-4 p-4 bg-white rounded-lg shadow-md mt-4">
                            <div class="text-center p-4 text-gray-500">جاري تحميل التعليقات...</div>
                        </div>

                        <div id="add-comment-form-container" class="mt-6 p-4 bg-white rounded-lg shadow-md">
                            <form id="add-comment-form" class="flex items-start gap-3">
                                <img id="commenter-avatar" src="https://placehold.co/40x40/E0E0E0/B0B0B0?text=User" alt="User Avatar" class="size-10 rounded-full shrink-0 object-cover">
                                <textarea id="comment-text" placeholder="أضف تعليقاً..." required class="form-input flex-1 resize-none rounded-lg border-gray-300 focus:ring-[#1978e5] focus:border-[#1978e5] p-3 text-base" rows="3"></textarea>
                                <button type="submit" class="form-button self-end bg-[#1978e5] text-slate-50 h-12 px-6">نشر</button>
                            </form>
                        </div>
                    </div>
                </section>

                <section id="flash-feed" class="content-section hidden-section px-5 md:px-20 lg:px-40 py-5">
                </section>

                <section id="contact" class="content-section hidden-section px-5 md:px-20 lg:px-40 py-10 text-center">
                    <h2 class="text-[#0e141b] text-3xl font-bold mb-6">اتصل بنا</h2>
                    <p class="text-[#0e141b] text-lg mb-4">
                        إذا كانت لديك أي أسئلة أو اقتراحات، فلا تتردد في التواصل معنا.
                    </p>
                     <a href="mailto:MinaHanna@IEEE.ORG" class="form-button bg-[#1978e5] text-slate-50 hover:bg-blue-700 inline-flex items-center justify-center px-6 py-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-envelope-fill ml-2" viewBox="0 0 16 16">
                          <path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757Zm3.436-.586L16 11.801V4.697l-5.803 3.546Z"/>
                        </svg>
                        <span>اتصل بنا عبر البريد الإلكتروني</span>
                    </a>
                    <p class="text-gray-600 mt-4">أو تابعنا على وسائل التواصل الاجتماعي!</p>
                </section>


            </main>

            <footer class="flex justify-center border-t border-solid border-t-[#e7edf3] bg-white">
                <div class="flex max-w-[960px] flex-1 flex-col">
                    <div class="flex flex-col gap-6 px-5 py-10 text-center @container">
                        <div class="flex flex-wrap items-center justify-center gap-6 @[480px]:flex-row @[480px]:justify-around">
                            <a class="text-[#4e7097] text-base font-normal leading-normal min-w-40 hover:text-[#1978e5]" href="#">سياسة الخصوصية</a>
                            <a class="text-[#4e7097] text-base font-normal leading-normal min-w-40 hover:text-[#1978e5]" href="#">شروط الخدمة</a>
                            <a class="nav-link text-[#4e7097] text-base font-normal leading-normal min-w-40 hover:text-[#1978e5]" href="#" data-target="contact">اتصل بنا</a>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4">
                            <a href="#" aria-label="Twitter"><div class="text-[#4e7097] hover:text-[#1978e5]" data-icon="TwitterLogo" data-size="24px"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M247.39,68.94A8,8,0,0,0,240,64H209.57A48.66,48.66,0,0,0,168.1,40a46.91,46.91,0,0,0-33.75,13.7A47.9,47.9,0,0,0,120,88v6.09C79.74,83.47,46.81,50.72,46.46,50.37a8,8,0,0,0-13.65,4.92c-4.31,47.79,9.57,79.77,22,98.18a110.93,110.93,0,0,0,21.88,24.2c-15.23,17.53-39.21,26.74-39.47,26.84a8,8,0,0,0-3.85,11.93c.75,1.12,3.75,5.05,11.08,8.72C53.51,229.7,65.48,232,80,232c70.67,0,129.72-54.42,135.75-124.44l29.91-29.9A8,8,0,0,0,247.39,68.94Zm-45,29.41a8,8,0,0,0-2.32,5.14C196,166.58,143.28,216,80,216c-10.56,0-18-1.4-23.22-3.08,11.51-6.25,27.56-17,37.88-32.48A8,8,0,0,0,92,169.08c-.47-.27-43.91-26.34-44-96,16,13,45.25,33.17,78.67,38.79A8,8,0,0,0,136,104V88a32,32,0,0,1,9.6-22.92A30.94,30.94,0,0,1,167.9,56c12.66.16,24.49,7.88,29.44,19.21A8,8,0,0,0,204.67,80h16Z"></path></svg></div></a>
                            <a href="#" aria-label="Instagram"><div class="text-[#4e7097] hover:text-[#1978e5]" data-icon="InstagramLogo" data-size="24px"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160ZM176,24H80A56.06,56.06,0,0,0,24,80v96a56.06,56.06,0,0,0,56,56h96a56.06,56.06,0,0,0,56-56V80A56.06,56.06,0,0,0,176,24Zm40,152a40,40,0,0,1-40,40H80a40,40,0,0,1-40-40V80A40,40,0,0,1,80,40h96a40,40,0,0,1,40,40ZM192,76a12,12,0,1,1-12-12A12,12,0,0,1,192,76Z"></path></svg></div></a>
                        </div>
                        <p class="text-[#4e7097] text-base font-normal leading-normal">@2025 فريق Flash. جميع الحقوق محفوظة.</p>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <div id="messageModal" class="modal hidden-section">
        <div class="modal-content">
            <p id="modalMessageText"></p>
            <button id="modalCloseBtn" class="modal-close-btn">إغلاق</button>
        </div>
    </div>
    
    <div id="confirmModal" class="modal hidden-section">
        <div class="modal-content">
            <p id="confirmModalMessage" class="mb-4"></p>
            <div class="flex justify-center gap-4">
                <button id="confirmModalConfirmBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    تأكيد
                </button>
                <button id="confirmModalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                    إلغاء
                </button>
            </div>
        </div>
    </div>


    <script>
        // Supabase Credentials
        const SUPABASE_URL = 'https://uzcrjhhvwgllsdsvftuj.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6Y3JqaGh2d2dsbHNkc3ZmdHVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMTcxNzcsImV4cCI6MjA2Mzc5MzE3N30.wy_ei_ZVJoMGbXMVqrW8NVUEgk2-EvPQYpgb9gWMW18';
        const ADMIN_SECRET_CODE = "FLASH_ADMIN_2024"; 

        // --- Modal Elements ---
        const messageModal = document.getElementById('messageModal');
        const modalMessageText = document.getElementById('modalMessageText');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');
        const confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
        let confirmCallback = null;
        
        function showModalMessage(message, isError = false) {
            if (modalMessageText && messageModal) {
                modalMessageText.textContent = message;
                modalMessageText.className = isError ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold';
                messageModal.classList.remove('hidden-section');
            } else {
                console.error("Modal elements not found. Message:", message);
            }
        }
         function showConfirmModal(message, callback) {
            confirmModalMessage.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden-section');
        }

        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', () => {
                if (messageModal) messageModal.classList.add('hidden-section');
            });
        }
        if (confirmModalConfirmBtn) {
            confirmModalConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                confirmModal.classList.add('hidden-section');
                confirmCallback = null;
            });
        }
        if (confirmModalCancelBtn) {
            confirmModalCancelBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden-section');
                confirmCallback = null;
            });
        }

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL === 'YOUR_SUPABASE_URL') { 
            console.warn('Supabase URL and Anon Key might still be placeholders or missing.');
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                 showModalMessage('خطأ في الإعداد: يرجى التأكد من صحة Supabase URL و Anon Key.');
            }
        }
        
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Global Variables for Auth and Navigation ---
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        let currentEventId = null; 
        let currentUser = null; 
        let initialAuthProcessed = false; 
        let editingEventId = null; 
        let isNavigating = false; // Guard flag for navigation

        // --- Variables for multiple image handling ---
        let eventImageFilesToUpload = []; 
        let existingEventImageUrls = [];   
        let selectedMainImagePreviewUrl = null; 
        const MAX_EVENT_IMAGES = 10;


        // --- Common styles (already applied in HTML, kept for reference if needed by JS) ---
        const inputFieldStyles = "form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#101418] focus:outline-0 focus:ring-2 focus:ring-[#1978e5] border border-[#d4dbe2] bg-gray-50 focus:border-[#1978e5] h-14 placeholder:text-[#5c718a] p-[15px] text-base font-normal leading-normal";
        const formButtonStyles = "flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-4 text-base font-bold leading-normal tracking-[0.015em] transition-colors";
        document.querySelectorAll('.input-field').forEach(el => el.className = inputFieldStyles);
        document.querySelectorAll('.form-button').forEach(el => el.className = `${formButtonStyles} ${el.className}`);


        // --- Navigation ---
        async function navigateTo(targetId, eventData = null) { 
            if (isNavigating && targetId !== 'login') { 
                console.warn(`Navigation to ${targetId} blocked, already navigating.`);
                return;
            }
            isNavigating = true;
            console.log(`Navigating to: ${targetId}`, eventData); 

            contentSections.forEach(section => {
                section.classList.add('hidden-section');
            });
            navLinks.forEach(link => {
                link.classList.remove('nav-active');
                if (link.dataset.target === targetId) {
                    link.classList.add('nav-active');
                }
            });

            const targetSection = document.getElementById(targetId);

            if (targetId === 'my-profile-section' && !currentUser) {
                console.log("Access to my-profile-section denied, showing login.");
                const loginSection = document.getElementById('login');
                if (loginSection) {
                    loginSection.classList.remove('hidden-section');
                    navLinks.forEach(link => {
                        link.classList.remove('nav-active');
                        if (link.dataset.target === 'login') { link.classList.add('nav-active'); }
                    });
                } else {
                    document.getElementById('home').classList.remove('hidden-section'); // Fallback
                }
                isNavigating = false; 
                return; 
            }

            if (targetSection) {
                targetSection.classList.remove('hidden-section');
                window.scrollTo(0, 0); 
                try {
                    if (targetId === 'profiles') await loadProfiles();
                    if (targetId === 'my-profile-section' && currentUser) { 
                        await loadCurrentUserProfileData();
                    }
                    if (targetId === 'events') await loadEvents();
                    if (targetId === 'event-details' && eventData) {
                        currentEventId = eventData.id; 
                        await loadEventDetails(eventData);
                    }
                } catch (loadError) {
                    console.error(`Error loading content for ${targetId}:`, loadError);
                    showModalMessage(`فشل تحميل محتوى قسم ${targetId}.`, true);
                }
            } else {
                console.error(`Section with id "${targetId}" not found. Defaulting to home.`);
                document.getElementById('home').classList.remove('hidden-section'); 
            }
            // Release navigation lock slightly later to ensure all async operations in load functions might have started
            setTimeout(() => { isNavigating = false; }, 50); 
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = e.currentTarget.dataset.target;
                navigateTo(targetId); 
                const mobileMenu = document.getElementById('mobile-menu');
                if (mobileMenu && !mobileMenu.classList.contains('hidden-section')) {
                    mobileMenu.classList.add('hidden-section');
                }
            });
        });
        
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');

        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden-section');
            });
        }

        // --- Authentication Elements ---
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const authLinks = document.getElementById('auth-links');
        const userInfoDisplay = document.getElementById('user-info');
        const userNameNav = document.getElementById('user-name-nav');
        const userAvatarNav = document.getElementById('user-avatar-nav');
        const navLogoutBtn = document.getElementById('nav-logout-btn');
        const commenterAvatar = document.getElementById('commenter-avatar');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const myProfileNavLink = document.getElementById('my-profile-nav-link');
        const myProfileNavLinkMobile = document.getElementById('my-profile-nav-link-mobile');
        const createEventBtnGeneral = document.getElementById('create-event-btn');


        // --- Authentication Logic ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                if (data.user) {
                    showModalMessage('تم تسجيل الدخول بنجاح!');
                } else {
                    showModalMessage('فشل تسجيل الدخول. الرجاء المحاولة مرة أخرى.', true);
                }
            } catch (error) {
                showModalMessage(`خطأ في تسجيل الدخول: ${error.message}`, true);
                console.error("Login error:", error);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const fullName = document.getElementById('signup-fullname').value; 
            const academicId = document.getElementById('signup-academic-id').value; 
            const enteredAdminCode = document.getElementById('signup-admin-code-input').value;
            
            let assignedRole = 'user';
            if (enteredAdminCode === ADMIN_SECRET_CODE) {
                assignedRole = 'admin';
            }

            try {
                const { data: authData, error: authError } = await _supabase.auth.signUp({
                    email,
                    password,
                    options: { 
                        data: { 
                            full_name: fullName, 
                            user_name: fullName, 
                            academic_id: academicId || null, 
                            role: assignedRole 
                        }
                    }
                });

                if (authError) throw authError;

                if (authData.user) {
                    showModalMessage('تم إنشاء حساب المصادقة بنجاح! يرجى التحقق من بريدك الإلكتروني لتفعيل الحساب.');
                } else {
                    showModalMessage('حدث خطأ غير متوقع أثناء إنشاء الحساب. الرجاء المحاولة مرة أخرى.', true);
                }
            } catch (authError) {
                let userMessage = `خطأ في إنشاء حساب المصادقة: ${authError.message}.`;
                if (authError.message.toLowerCase().includes('for security purposes, you can only request this after')) {
                    const secondsMatch = authError.message.match(/\d+/);
                    const secondsToWait = secondsMatch ? secondsMatch[0] : 'بعض';
                    userMessage = `تم تجاوز حد محاولات إنشاء الحساب. لأسباب أمنية، يرجى الانتظار ${secondsToWait} ثواني ثم المحاولة مرة أخرى.`;
                } else if (authError.message.toLowerCase().includes('database error saving new user')) {
                     userMessage += " هذا الخطأ يحدث غالبًا بسبب مشكلة في trigger قاعدة البيانات أو دالة SQL مرتبطة به. يرجى مراجعة إعدادات قاعدة البيانات.";
                }
                showModalMessage(userMessage, true);
                console.error("Signup auth error:", authError); 
            }
        });
        
        navLogoutBtn.addEventListener('click', async () => {
            console.log("Logout button clicked. Current user before signout:", currentUser);
            if (!currentUser) {
                showModalMessage('أنت غير مسجل الدخول حاليًا.', true);
                // No need to call updateAuthState or navigateTo here explicitly,
                // onAuthStateChange will handle the state if it's inconsistent
                // or if the UI needs to reflect a "not logged in" state.
                return;
            }
            try {
                const { error } = await _supabase.auth.signOut();
                if (error) {
                    throw error;
                }
                showModalMessage('تم تسجيل الخروج بنجاح.');
                // onAuthStateChange will be triggered with (event: 'SIGNED_OUT', session: null)
                // and will then call updateAuthState(null) and navigateTo('home').
            } catch (error) {
                showModalMessage(`خطأ في تسجيل الخروج: ${error.message}`, true);
                console.error("Logout error:", error);
            }
        });

        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-password-email').value;
            const redirectTo = 'https://minal0p.github.io/Flash-Team-Reset-Password/'; 

            try {
                const { error } = await _supabase.auth.resetPasswordForEmail(email, { redirectTo });
                if (error) throw error;
                showModalMessage('إذا كان البريد الإلكتروني موجودًا، فسيتم إرسال رابط إعادة تعيين كلمة المرور إليه.');
                navigateTo('login'); 
            } catch (error) {
                showModalMessage(`خطأ في إرسال رابط إعادة التعيين: ${error.message}`, true);
                console.error('Forgot password error:', error.message);
            }
        });

        async function updateAuthState(user) {
            console.log("Updating auth state for user:", user); 
            currentUser = user; // Ensure global currentUser is updated first

            const authLinks = document.getElementById('auth-links');
            const userInfoDisplay = document.getElementById('user-info');
            const myProfileNavLink = document.getElementById('my-profile-nav-link');
            const myProfileNavLinkMobile = document.getElementById('my-profile-nav-link-mobile');
            const createEventBtnGeneral = document.getElementById('create-event-btn');
            const userNameNav = document.getElementById('user-name-nav');
            const userAvatarNav = document.getElementById('user-avatar-nav');
            const commenterAvatar = document.getElementById('commenter-avatar');
            const updateProfileFormContainer = document.getElementById('current-user-profile-form-container');

            if (user) {
                authLinks.classList.add('hidden-section');
                myProfileNavLink.classList.remove('hidden-section');
                if (myProfileNavLinkMobile) myProfileNavLinkMobile.classList.remove('hidden-section');
                userInfoDisplay.classList.remove('hidden-section');

                try {
                    const { data: profile, error: profileError } = await _supabase
                        .from('profiles')
                        .select('full_name, avatar_url, role') 
                        .eq('id', user.id)
                        .single();

                    if (profileError) {
                        console.error("Error fetching profile for UI update:", profileError);
                        userNameNav.textContent = user.email; 
                        userAvatarNav.src = 'https://placehold.co/32x32/E0E0E0/B0B0B0?text=U';
                        commenterAvatar.src = 'https://placehold.co/40x40/E0E0E0/B0B0B0?text=User';
                        if (createEventBtnGeneral) createEventBtnGeneral.classList.add('hidden-section'); 
                    } else if (profile) {
                        userNameNav.textContent = profile.full_name || user.email;
                        userAvatarNav.src = profile.avatar_url || 'https://placehold.co/32x32/E0E0E0/B0B0B0?text=U';
                        commenterAvatar.src = profile.avatar_url || 'https://placehold.co/40x40/E0E0E0/B0B0B0?text=User';
                        if (createEventBtnGeneral) {
                             createEventBtnGeneral.classList.toggle('hidden-section', profile.role !== 'admin');
                        }
                    } else {
                        console.warn("User authenticated but profile not found in DB for ID:", user.id);
                        userNameNav.textContent = user.email;
                        userAvatarNav.src = 'https://placehold.co/32x32/E0E0E0/B0B0B0?text=U';
                        commenterAvatar.src = 'https://placehold.co/40x40/E0E0E0/B0B0B0?text=User';
                        if (createEventBtnGeneral) createEventBtnGeneral.classList.add('hidden-section');
                    }
                } catch (e) { 
                    console.error("Unexpected error in updateAuthState profile section:", e);
                    userNameNav.textContent = user.email; 
                    userAvatarNav.src = 'https://placehold.co/32x32/E0E0E0/B0B0B0?text=U';
                    commenterAvatar.src = 'https://placehold.co/40x40/E0E0E0/B0B0B0?text=User';
                    if (createEventBtnGeneral) createEventBtnGeneral.classList.add('hidden-section');
                }
                
                const myProfileSection = document.getElementById('my-profile-section');
                if (myProfileSection && !myProfileSection.classList.contains('hidden-section')) {
                    if (updateProfileFormContainer) updateProfileFormContainer.classList.remove('hidden-section');
                    await loadCurrentUserProfileData(); 
                }

            } else { 
                authLinks.classList.remove('hidden-section');
                myProfileNavLink.classList.add('hidden-section');
                if (myProfileNavLinkMobile) myProfileNavLinkMobile.classList.add('hidden-section');
                userInfoDisplay.classList.add('hidden-section');
                userNameNav.textContent = '';
                userAvatarNav.src = 'https://placehold.co/32x32/E0E0E0/B0B0B0?text=U';
                commenterAvatar.src = 'https://placehold.co/40x40/E0E0E0/B0B0B0?text=User';
                if (updateProfileFormContainer) updateProfileFormContainer.classList.add('hidden-section');
                if (createEventBtnGeneral) createEventBtnGeneral.classList.add('hidden-section');
            }
        }
        
        _supabase.auth.onAuthStateChange(async (event, session) => { 
            console.log("onAuthStateChange - Event:", event, "Session:", session); 
            const previousUser = currentUser; 
            const newUser = session?.user || null; 
            
            currentUser = newUser; 
            
            await updateAuthState(newUser); 

            if (!initialAuthProcessed) {
                initialAuthProcessed = true;
                setTimeout(() => { 
                    const hash = window.location.hash.substring(1);
                    let targetPage = 'home'; 
                    if (hash && document.getElementById(hash)) {
                        targetPage = hash;
                    } else if (hash) { 
                        console.warn(`Hash target #${hash} not found, defaulting to home.`);
                    }
                    console.log("onAuthStateChange (Initial Navigation): Navigating to:", targetPage);
                    navigateTo(targetPage);
                }, 0); 
            } else if (event === 'SIGNED_IN' && !previousUser) { 
                const currentSectionId = Array.from(contentSections).find(s => !s.classList.contains('hidden-section'))?.id;
                if (currentSectionId === 'login' || currentSectionId === 'signup') {
                    console.log("onAuthStateChange (Post-Login Navigation): Navigating to home.");
                    navigateTo('home');
                }
            } else if (event === 'SIGNED_OUT') { 
                console.log("onAuthStateChange (Post-Signout Navigation): Navigating to home.");
                navigateTo('home');
            }
        });

        const teamMembersListContainer = document.getElementById('team-members-list'); 
        const updateProfileForm = document.getElementById('update-profile-form');
        const updateAvatarPreview = document.getElementById('update-avatar-preview');
        const updateAvatarFile = document.getElementById('update-avatar-file');

        updateAvatarFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    updateAvatarPreview.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        async function loadCurrentUserProfileData() {
            if (!currentUser) { 
                console.error('No user logged in, cannot load profile data.');
                document.getElementById('current-user-profile-form-container').classList.add('hidden-section');
                return;
            }
            document.getElementById('current-user-profile-form-container').classList.remove('hidden-section');

            try {
                const { data: profile, error } = await _supabase
                    .from('profiles')
                    .select('full_name, User_Name, academic_id, role, avatar_url')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;

                if (profile) {
                    document.getElementById('update-full-name').value = profile.full_name || '';
                    document.getElementById('update-user-name').value = profile.User_Name || '';
                    document.getElementById('update-academic-id').value = profile.academic_id || '';
                    document.getElementById('update-profile-role-display').textContent = profile.role || 'غير محدد';
                    updateAvatarPreview.src = profile.avatar_url || 'https://placehold.co/100x100/E0E0E0/B0B0B0?text=Avatar';
                } else {
                    console.warn("Current user profile not found in DB for ID:", currentUser.id);
                    document.getElementById('update-profile-form').reset();
                    updateAvatarPreview.src = 'https://placehold.co/100x100/E0E0E0/B0B0B0?text=Avatar';
                    document.getElementById('update-profile-role-display').textContent = 'غير محدد';
                }
            } catch (error) {
                console.error('Error fetching current user profile for editing:', error);
                showModalMessage(`فشل تحميل بيانات الملف الشخصي: ${error.message}`, true);
                document.getElementById('update-profile-form').reset();
                updateAvatarPreview.src = 'https://placehold.co/100x100/E0E0E0/B0B0B0?text=Avatar';
                document.getElementById('update-profile-role-display').textContent = 'غير محدد';
            }
        }


        updateProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { 
                showModalMessage('يجب تسجيل الدخول لتحديث الملف الشخصي.', true);
                return;
            }

            const fullName = document.getElementById('update-full-name').value;
            const userName = document.getElementById('update-user-name').value;
            const academicId = document.getElementById('update-academic-id').value;
            const avatarFile = document.getElementById('update-avatar-file').files[0];
            let avatarUrl = updateAvatarPreview.src; 

            try {
                if (avatarFile) {
                    const fileName = `${currentUser.id}/${Date.now()}-${avatarFile.name.replace(/\s+/g, '_')}`; 
                    const { data: uploadData, error: uploadError } = await _supabase.storage
                        .from('personal-image') 
                        .upload(fileName, avatarFile, { cacheControl: '3600', upsert: true });
                    if (uploadError) throw uploadError;
                    const { data: urlData } = _supabase.storage.from('personal-image').getPublicUrl(fileName);
                    avatarUrl = urlData.publicUrl;
                }
                
                const updates = {
                    full_name: fullName, User_Name: userName, academic_id: academicId,
                    avatar_url: avatarUrl, updated_at: new Date().toISOString()
                };

                const { error: updateError } = await _supabase
                    .from('profiles')
                    .update(updates)
                    .eq('id', currentUser.id);
                if (updateError) throw updateError;

                showModalMessage('تم تحديث الملف الشخصي بنجاح!');
                await updateAuthState(currentUser); 
            } catch (error) {
                showModalMessage(`فشل تحديث الملف الشخصي: ${error.message}`, true);
                console.error("Profile update error:", error);
            }
        });

        function createProfileCard(member) { 
            const imgSrc = member.imgUrl ? member.imgUrl : `https://placehold.co/70x70/1a1a1a/00f0ff?text=${encodeURIComponent(member.imgInitial || '؟')}&font=cairo`;
            const placeholderSrc = `https://placehold.co/70x70/1a1a1a/cccccc?text=${encodeURIComponent(member.imgInitial || '؟')}&font=cairo`;
            
            let socialLinksHTML = '<div class="flex justify-center space-x-2 mt-2">';
            if (member.linkedinUrl) {
                socialLinksHTML += `<a href="${member.linkedinUrl}" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400">
                                        <svg class="social-icon" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                                    </a>`;
            }
            if (member.facebookUrl) {
                socialLinksHTML += `<a href="${member.facebookUrl}" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400">
                                        <svg class="social-icon" viewBox="0 0 24 24"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"/></svg>
                                    </a>`;
            }
            if (member.phone) {
                 socialLinksHTML += `<a href="https://wa.me/${member.phone.replace(/\s+/g, '')}" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-green-500 dark:text-gray-400 dark:hover:text-green-400">
                                        <svg class="social-icon" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.712-.975z"/></svg>
                                    </a>`;
            }
            socialLinksHTML += '</div>';

            return `
                <div class="team-member-card p-2 sm:p-3 rounded-lg text-center" style="--animation-delay: ${member.animationDelay || 0}s;">
                    <img src="${imgSrc}" alt="صورة ${member.name || 'عضو'}" class="w-14 h-14 sm:w-16 sm:h-16 rounded-full mx-auto mb-1 border-2 shadow-md object-cover" onerror="this.onerror=null; this.src='${placeholderSrc}';">
                    <h3 class="text-xs font-bold mb-0.5 leading-tight">${member.name || 'عضو غير معروف'}</h3>
                    <p class="font-semibold text-xxs text-blue-500" style="font-size: 0.6rem;">${member.role || 'عضو'}</p>
                    ${socialLinksHTML}
                </div>`;
        }

        async function loadProfiles() {
            if (!teamMembersListContainer) {
                console.error("Profile container 'team-members-list' not found.");
                return; 
            }
            teamMembersListContainer.innerHTML = '<div class="text-center p-4 text-gray-500 col-span-full">جاري تحميل ملفات الفريق...</div>';
            
            const teamMembersData = [ 
                { name: "مينا حنا فهيم", role: "مهندس كهرباء", imgUrl: "https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/personal-image//Mina%20Hanna.png", imgInitial: "م.ح", linkedinUrl: "https://www.linkedin.com/in/engminahanna", facebookUrl: "https://www.facebook.com/Eng.Mina.H.F", phone: "+201203006152" },
                { name: "مينا فليب لبيب", role: "مهندس كهرباء", imgUrl: "https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/personal-image//Mena%20Philip.jpg", imgInitial: "م.ف", linkedinUrl: "https://www.linkedin.com/in/mena-philip-766454340", facebookUrl: "https://www.facebook.com/profile.php?id=100004623032980", phone: "+201228226064" },
                { name: "عمر عبد الهادي رمادي", role: "مهندس كهرباء", imgUrl: "https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/personal-image//Omar%20Ramady.png", imgInitial: "ع.ع", linkedinUrl: "https://www.linkedin.com/in/omar-al-ramady-3a2022206", facebookUrl: "https://www.facebook.com/omar.al.ramady.2025", phone: "+201118525778" },
                { name: "محمد سيد محمد حسان", role: "مهندس كهرباء", imgUrl: "https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/personal-image//Bakar.jpg", imgInitial: "م.س", linkedinUrl: "https://www.linkedin.com/in/mohammed-sayed-mohammed-1892382b8", facebookUrl: "https://www.facebook.com/share/15aNJqX3NS/", phone: "+201152216149" },
                { name: "محمد محمود بربري", role: "مهندس كهرباء", imgUrl: "https://scontent.fcai2-2.fna.fbcdn.net/v/t39.30808-6/470165541_4094575017436722_4593658555281273385_n.jpg?_nc_cat=100&ccb=1-7&_nc_sid=a5f93a&_nc_ohc=VJQgz6RpGeoQ7kNvwEx496C&_nc_oc=AdkF6Cy3nZgJQO6yCEtJBEwsgi5tgoopzrxjgBcugYfq5bwJoggbEp7WGh3mw_eF5QU&_nc_zt=23&_nc_ht=scontent.fcai2-2.fna&_nc_gid=u0NjoM5BSF6XuW5o5ZfQYA&oh=00_AfJlJ55AuNqroATBFoS7HT6x3TpFkV8VR4WXUaBlpz7DTQ&oe=683BE7E3", imgInitial: "م.م" },
                { name: "احمد طارق احمد محمد", role: "مهندس كهرباء", imgUrl: "https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/personal-image//Ahmed%20Tarek.jpg", imgInitial: "أ.ط", linkedinUrl: "https://www.linkedin.com/in/ahmed-tarek-a6b9061b6", facebookUrl: "https://www.facebook.com/share/1EGXAoeUcn/", phone: "+201023237803" },
                { name: "شروق محمد فتحي", role: "مهندس كهرباء", imgInitial: "ش.م" },
                { name: "فرحه محمد صلاح", role: "مهندس كهرباء", imgInitial: "ف.م" },
                { name: "حسن السيد فواز", role: "مهندس كهرباء", imgInitial: "ح.ا" },
                { name: "احمد اشرف سليمان", role: "مهندس كهرباء", imgUrl: "https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/personal-image//Ahmed%20Ashraf.jpg", imgInitial: "أ.أ", linkedinUrl: "https://www.linkedin.com/in/ahmed-ashraf-soliman-772038267", facebookUrl: "https://www.facebook.com/share/19boqUX4LV/", phone: "+201204800317" },
                { name: "كريم احمد نور الدين", role: "مهندس كهرباء", imgUrl: "https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/personal-image//Karim%20Ahmed.jpg", imgInitial: "ك.أ", linkedinUrl: "https://www.linkedin.com/in/karim-ahmed-b68877251", facebookUrl: "https://www.facebook.com/share/1Mu5LQo5sK/?mibextid=wwXIfr", phone: "+201006036359" },
                { name: "محمد يوسف عمار", role: "مهندس كهرباء", imgUrl: "https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/personal-image//Mohamed%20Yousef.jpg", imgInitial: "م.ي", linkedinUrl: "https://www.linkedin.com/in/mohamed-yousef-bab471352", facebookUrl: "https://www.facebook.com/share/19JDJBVuch/", phone: "+201063815096" }
            ];
            const vacantSpots = 3; 
            let memberHtml = '';

            teamMembersData.forEach((member, index) => {
                 const profileData = { 
                    name: member.name, role: member.role, imgUrl: member.imgUrl, imgInitial: member.imgInitial,
                    linkedinUrl: member.linkedinUrl, facebookUrl: member.facebookUrl, phone: member.phone,
                    animationDelay: `${index * 0.05}s`,
                    academic_id: 'N/A', User_Name: member.name ? member.name.toLowerCase().replace(/\s+/g, '_') : `user_${index}` 
                };
                memberHtml += createProfileCard(profileData); 
            });

            for (let i = 0; i < vacantSpots; i++) {
                memberHtml += `
                <div class="team-member-card p-2 sm:p-3 rounded-lg text-center bg-gray-700 bg-opacity-20 border-gray-600" style="--animation-delay: ${(teamMembersData.length + i) * 0.05}s;">
                    <div>
                        <img src="https://placehold.co/70x70/333333/888888?text=؟${i+1}&font=cairo" alt="مكان شاغر ${i+1}" class="w-14 h-14 sm:w-16 sm:h-16 rounded-full mx-auto mb-1 border-2 border-gray-500 shadow-md">
                        <h3 class="text-xs font-bold text-gray-300 mb-0.5 leading-tight">مكان شاغر ${i+1}</h3>
                        <p class="text-gray-400 mb-1 text-xxs" style="font-size: 0.6rem;">انضم إلينا!</p>
                    </div>
                    <button onclick="showModalMessage('اقتراح مهام', 'ميزة اقتراح المهام غير متاحة حاليًا.')" class="btn btn-secondary text-xxs py-1 px-2 w-full mt-auto bg-gray-500 hover:bg-gray-600 text-white rounded" style="font-size: 0.55rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-info-circle mr-1"></i> تفاصيل
                    </button>
                </div>`;
            }
            teamMembersListContainer.innerHTML = memberHtml;
        }
        

        const upcomingEventsList = document.getElementById('upcoming-events-list');
        const pastEventsList = document.getElementById('past-events-list');
        const eventDetailsContent = document.getElementById('event-details-content');
        const eventDetailsMainImage = document.getElementById('event-details-main-image');
        const eventDetailsGallery = document.getElementById('event-details-gallery');
        const eventCommentsList = document.getElementById('event-comments-list');
        const addCommentForm = document.getElementById('add-comment-form');
        const createEventFormContainer = document.getElementById('create-event-form-container');
        const createEventForm = document.getElementById('create-event-form');
        const cancelCreateEventBtn = document.getElementById('cancel-create-event-btn');
        const eventFormTitle = document.getElementById('event-form-title');
        const submitEventFormBtn = document.getElementById('submit-event-form-btn');
        const eventImageFilesInput = document.getElementById('event-image-files');
        const eventImagesPreviewContainer = document.getElementById('event-images-preview-container');


        // --- Multiple Image Handling for Event Form ---
        function renderImagePreviews() {
            eventImagesPreviewContainer.innerHTML = ''; // Clear existing previews

            // Render previews for existing URLs (when editing)
            if (Array.isArray(existingEventImageUrls)) { 
                existingEventImageUrls.forEach(url => {
                    const previewItem = createImagePreviewElement(url, url, false);
                    eventImagesPreviewContainer.appendChild(previewItem);
                });
            } else if (existingEventImageUrls) { 
                 console.warn("renderImagePreviews: existingEventImageUrls was not an array but had a value. Treating as single image URL for preview.", existingEventImageUrls);
                 const previewItem = createImagePreviewElement(existingEventImageUrls, existingEventImageUrls, false);
                 eventImagesPreviewContainer.appendChild(previewItem);
            }


            // Render previews for newly selected files
            eventImageFilesToUpload.forEach((file, index) => {
                const localUrl = URL.createObjectURL(file);
                const previewItem = createImagePreviewElement(localUrl, localUrl, true, index); 
                eventImagesPreviewContainer.appendChild(previewItem);
            });
            updateSelectedMainImageStyle();
        }

        function createImagePreviewElement(displaySrc, originalIdentifier, isNewFile, fileIndex = -1) {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'relative group';

            const img = document.createElement('img');
            img.src = displaySrc;
            img.alt = 'معاينة الصورة';
            img.className = 'event-image-preview-item w-full h-full object-cover rounded-md';
            img.dataset.identifier = originalIdentifier; 

            img.onclick = () => {
                selectedMainImagePreviewUrl = originalIdentifier; 
                updateSelectedMainImageStyle();
            };
            imgContainer.appendChild(img);
            
            if (isNewFile) {
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-75 group-hover:opacity-100';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    eventImageFilesToUpload.splice(fileIndex, 1); 
                    if (selectedMainImagePreviewUrl === displaySrc) { 
                        selectedMainImagePreviewUrl = (existingEventImageUrls.length > 0 && Array.isArray(existingEventImageUrls)) ? existingEventImageUrls[0] : (eventImageFilesToUpload.length > 0 ? URL.createObjectURL(eventImageFilesToUpload[0]) : null);
                    }
                    renderImagePreviews(); 
                };
                imgContainer.appendChild(deleteBtn);
            }
            return imgContainer;
        }
        
        function updateSelectedMainImageStyle() {
            document.querySelectorAll('.event-image-preview-item').forEach(item => {
                item.classList.remove('selected-main');
                if (item.dataset.identifier === selectedMainImagePreviewUrl) {
                    item.classList.add('selected-main');
                }
            });
        }

        if (eventImageFilesInput) {
            eventImageFilesInput.addEventListener('change', (event) => {
                const files = Array.from(event.target.files);
                const currentPreviewsCount = Array.isArray(existingEventImageUrls) ? existingEventImageUrls.length : (existingEventImageUrls ? 1 : 0);
                const totalImages = currentPreviewsCount + eventImageFilesToUpload.length + files.length;


                if (totalImages > MAX_EVENT_IMAGES) {
                    showModalMessage(`لا يمكن رفع أكثر من ${MAX_EVENT_IMAGES} صور.`, true);
                    event.target.value = ""; 
                    return;
                }
                eventImageFilesToUpload.push(...files); 
                if (!selectedMainImagePreviewUrl && eventImageFilesToUpload.length > 0) {
                    selectedMainImagePreviewUrl = URL.createObjectURL(eventImageFilesToUpload[0]);
                }
                renderImagePreviews();
            });
        }


        createEventBtnGeneral.addEventListener('click', () => {
            editingEventId = null; 
            eventImageFilesToUpload = [];
            existingEventImageUrls = [];
            selectedMainImagePreviewUrl = null;
            eventFormTitle.textContent = 'إنشاء فعالية جديدة';
            submitEventFormBtn.textContent = 'إنشاء';
            createEventForm.reset(); 
            renderImagePreviews(); 
            createEventFormContainer.classList.remove('hidden-section');
            createEventBtnGeneral.classList.add('hidden-section'); 
        });

        cancelCreateEventBtn.addEventListener('click', () => {
            createEventFormContainer.classList.add('hidden-section');
            if (currentUser) { 
                 updateAuthState(currentUser); 
            } else {
                createEventBtnGeneral.classList.add('hidden-section');
            }
            createEventForm.reset();
            editingEventId = null;
            eventImageFilesToUpload = [];
            existingEventImageUrls = [];
            selectedMainImagePreviewUrl = null;
            renderImagePreviews(); 
        });

        createEventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { 
                showModalMessage('يجب تسجيل الدخول لإنشاء أو تعديل فعالية.', true);
                navigateTo('login');
                return;
            }

            const title = document.getElementById('event-title').value;
            const description = document.getElementById('event-description').value;
            const event_date = document.getElementById('event-date').value;
            
            let uploadedImageUrls = [];
            // Ensure existingEventImageUrls is an array before spreading
            let finalImageUrls = Array.isArray(existingEventImageUrls) ? [...existingEventImageUrls] : (existingEventImageUrls ? [existingEventImageUrls] : []);


            try {
                for (const file of eventImageFilesToUpload) {
                    const fileName = `event_${currentUser.id}_${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
                    const { data: uploadData, error: uploadError } = await _supabase.storage
                        .from('events-images').upload(fileName, file, { cacheControl: '3600', upsert: false });
                    if (uploadError) throw uploadError;
                    const { data: urlData } = _supabase.storage.from('events-images').getPublicUrl(fileName);
                    uploadedImageUrls.push(urlData.publicUrl);
                }

                finalImageUrls.push(...uploadedImageUrls);
                finalImageUrls = finalImageUrls.slice(0, MAX_EVENT_IMAGES); 

                let mainImageUrlToSave = selectedMainImagePreviewUrl;
                const newMainFileIndex = eventImageFilesToUpload.findIndex(f => selectedMainImagePreviewUrl && URL.createObjectURL(f) === selectedMainImagePreviewUrl);
                if (newMainFileIndex !== -1 && uploadedImageUrls[newMainFileIndex]) {
                    mainImageUrlToSave = uploadedImageUrls[newMainFileIndex];
                } else if (!finalImageUrls.includes(mainImageUrlToSave) && finalImageUrls.length > 0) {
                    mainImageUrlToSave = finalImageUrls[0];
                } else if (finalImageUrls.length === 0) {
                    mainImageUrlToSave = null; 
                }


                const eventDataPayload = { 
                    title, description, event_date, 
                    image_urls: finalImageUrls, 
                    main_image_url: mainImageUrlToSave, 
                    user_id: currentUser.id 
                };
                let operationError = null;

                if (editingEventId) {
                    const updatePayload = { ...eventDataPayload, updated_at: new Date().toISOString() };
                    delete updatePayload.user_id; 
                    const { error } = await _supabase.from('project_events').update(updatePayload)
                                        .eq('id', editingEventId).eq('user_id', currentUser.id); 
                    operationError = error;
                } else {
                    const { error } = await _supabase.from('project_events').insert(eventDataPayload);
                    operationError = error;
                }
                if (operationError) throw operationError;

                showModalMessage(`تم ${editingEventId ? 'تحديث' : 'إنشاء'} الفعالية بنجاح!`);
                createEventForm.reset();
                eventImageFilesInput.value = ''; 
                eventImageFilesToUpload = [];
                existingEventImageUrls = [];
                selectedMainImagePreviewUrl = null;
                renderImagePreviews(); 
                createEventFormContainer.classList.add('hidden-section');
                if (currentUser) updateAuthState(currentUser); 
                editingEventId = null; 
                await loadEvents(); 
            } catch (error) {
                showModalMessage(`فشل ${editingEventId ? 'تحديث' : 'إنشاء'} الفعالية: ${error.message}`, true);
                console.error("Event form submission error:", error);
            }
        });

        function createEventCard(eventItem, isUpcoming = true) {
            const eventDate = new Date(eventItem.event_date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
            const reactionTypes = [
                { type: 'like', emoji: '👍', label: 'أعجبني' }, { type: 'love', emoji: '❤️', label: 'أحببته' },
                { type: 'sad', emoji: '😢', label: 'أحزنني' }
            ];
            let reactionButtonsHTML = reactionTypes.map(rt => `
                <button class="reaction-btn p-1 rounded-full hover:bg-gray-200 focus:outline-none" data-eventid="${eventItem.id}" data-reactiontype="${rt.type}" aria-label="${rt.label}">
                    <span id="${rt.type}-icon-${eventItem.id}" class="text-xl">${rt.emoji}</span>
                </button>
                <span id="${rt.type}-count-${eventItem.id}" class="text-xs text-slate-500 mr-1">0</span>
            `).join('');
            
            let ownerControlsHTML = '';
            if (currentUser && currentUser.id === eventItem.user_id) {
                ownerControlsHTML = `
                    <button class="edit-event-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-black py-1 px-2 rounded mr-2" data-eventid="${eventItem.id}">تعديل</button>
                    <button class="delete-event-btn text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded" data-eventid="${eventItem.id}" data-imageurls="${JSON.stringify(eventItem.image_urls || [])}">حذف</button>
                `;
            }
            const displayImageUrl = eventItem.main_image_url || (eventItem.image_urls && Array.isArray(eventItem.image_urls) && eventItem.image_urls.length > 0 ? eventItem.image_urls[0] : 'https://placehold.co/400x300/64748B/E0E7FF?text=Event+Image');

            const cardHTML = `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="md:flex">
                        <div class="md:shrink-0 md:w-1/3">
                            <img class="h-48 w-full object-cover md:h-full event-image" src="${displayImageUrl}" alt="${eventItem.title}">
                        </div>
                        <div class="p-6 md:w-2/3 flex flex-col justify-between">
                            <div>
                                <div class="uppercase tracking-wide text-sm text-[#1978e5] font-semibold">${eventDate}</div>
                                <a href="#" class="block mt-1 text-lg leading-tight font-medium text-black hover:underline event-details-link" data-eventid="${eventItem.id}">${eventItem.title}</a>
                                <p class="mt-2 text-slate-600 text-sm">${eventItem.description ? eventItem.description.substring(0, 150) + (eventItem.description.length > 150 ? '...' : '') : 'لا يوجد وصف متاح.'}</p>
                            </div>
                             <div class="mt-2"> ${ownerControlsHTML} </div>
                            <div class="mt-4 flex justify-between items-center">
                                <button class="event-details-link text-sm font-medium text-[#1978e5] hover:text-blue-700 py-2 px-3 rounded-md bg-blue-50 hover:bg-blue-100 transition" data-eventid="${eventItem.id}">
                                    ${isUpcoming ? 'معرفة المزيد' : 'عرض التفاصيل'}
                                </button>
                                <div class="flex items-center gap-2 text-slate-500 text-xs">
                                    ${reactionButtonsHTML}
                                    <button class="toggle-comment-btn p-1 rounded-full hover:bg-gray-200 focus:outline-none" data-eventid="${eventItem.id}" aria-label="تعليق">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-dots text-gray-400" viewBox="0 0 16 16"><path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/> <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/></svg>
                                    </button>
                                    <span id="comments-count-${eventItem.id}">0</span>
                                </div>
                            </div>
                            <div id="quick-comment-container-${eventItem.id}" class="hidden-section p-2 border-t mt-2">
                                <textarea id="quick-comment-text-${eventItem.id}" class="w-full p-2 border rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="اكتب تعليقاً سريعاً..."></textarea>
                                <button class="post-quick-comment-btn mt-1 text-xs bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-600" data-eventid="${eventItem.id}">نشر التعليق</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            fetchEventCounts(eventItem.id);
            checkUserReaction(eventItem.id); 
            return cardHTML;
        }
        
        async function fetchEventCounts(eventId, forDetails = false) {
            const suffix = forDetails ? '-details' : '';
            const reactionTypes = ['like', 'love', 'sad'];
            try {
                for (const type of reactionTypes) {
                    const { count, error } = await _supabase.from('event_reactions').select('*', { count: 'exact', head: true })
                                            .eq('event_id', eventId).eq('reaction_type', type);
                    if (error) console.warn(`Error fetching ${type} count for event ${eventId}:`, error.message);
                    const countElement = document.getElementById(`${type}-count${suffix}-${eventId}`);
                    if (countElement) countElement.textContent = count || 0;
                }
                const { count: commentsCount, error: commentsError } = await _supabase.from('event_comments')
                                                                    .select('*', { count: 'exact', head: true })
                                                                    .eq('event_id', eventId);
                if (commentsError) console.warn(`Error fetching comments count for event ${eventId}:`, commentsError.message);
                const commentCountElement = document.getElementById(`comments-count${suffix}-${eventId}`);
                if (commentCountElement) commentCountElement.textContent = commentsCount || 0;
            } catch (e) { console.error("Error in fetchEventCounts:", e); }
        }

        async function checkUserReaction(eventId, forDetails = false) {
            if (!currentUser) return; 
            const suffix = forDetails ? '-details' : '';
            try {
                const { data: userReaction, error } = await _supabase.from('event_reactions').select('reaction_type')
                                                    .eq('event_id', eventId).eq('user_id', currentUser.id).maybeSingle(); 
                if (error) throw error;

                const reactionTypes = ['like', 'love', 'sad'];
                reactionTypes.forEach(type => {
                    const iconElement = document.getElementById(`${type}-icon${suffix}-${eventId}`);
                    if (iconElement) {
                        iconElement.classList.remove('selected', 'text-blue-600', 'text-red-600', 'text-yellow-500'); 
                    }
                });

                if (userReaction && userReaction.reaction_type) {
                    const activeIconElement = document.getElementById(`${userReaction.reaction_type}-icon${suffix}-${eventId}`);
                    if (activeIconElement) {
                        activeIconElement.classList.add('selected');
                        if(userReaction.reaction_type === 'like') activeIconElement.classList.add('text-blue-600');
                        if(userReaction.reaction_type === 'love') activeIconElement.classList.add('text-red-600');
                        if(userReaction.reaction_type === 'sad') activeIconElement.classList.add('text-yellow-500'); 
                    }
                }
            } catch (error) { console.error(`Error checking user reaction for event ${eventId}:`, error.message); }
        }

        async function handleReaction(eventId, reactionType, fromDetails = false) {
            if (!currentUser) { 
                showModalMessage('يجب تسجيل الدخول للتفاعل.', true); navigateTo('login'); return;
            }
            try {
                const { data: existingReaction, error: fetchError } = await _supabase.from('event_reactions')
                    .select('id, reaction_type').eq('event_id', eventId).eq('user_id', currentUser.id).maybeSingle(); 
                if (fetchError) throw fetchError;

                if (existingReaction) { 
                    if (existingReaction.reaction_type === reactionType) { 
                        const { error: deleteError } = await _supabase.from('event_reactions').delete().match({ id: existingReaction.id });
                        if (deleteError) throw deleteError;
                    } else { 
                        const { error: updateError } = await _supabase.from('event_reactions')
                            .update({ reaction_type: reactionType, created_at: new Date().toISOString() }).match({ id: existingReaction.id });
                        if (updateError) throw updateError;
                    }
                } else { 
                    const { error: insertError } = await _supabase.from('event_reactions')
                        .insert({ event_id: eventId, user_id: currentUser.id, reaction_type: reactionType });
                    if (insertError) throw insertError;
                }
                await fetchEventCounts(eventId, fromDetails); 
                await checkUserReaction(eventId, fromDetails); 
                await fetchEventCounts(eventId, !fromDetails); 
                await checkUserReaction(eventId, !fromDetails);
            } catch (error) {
                showModalMessage(`خطأ في معالجة التفاعل: ${error.message}`, true);
                console.error("Reaction handling error:", error);
            }
        }

        function toggleQuickComment(eventId) {
            const container = document.getElementById(`quick-comment-container-${eventId}`);
            if (container) container.classList.toggle('hidden-section');
        }

        async function postQuickComment(eventId) {
            if (!currentUser) { 
                showModalMessage('يجب تسجيل الدخول للتعليق.', true); navigateTo('login'); return;
            }
            const commentTextElement = document.getElementById(`quick-comment-text-${eventId}`);
            const commentText = commentTextElement.value;
            if (!commentText.trim()) { showModalMessage('لا يمكن إرسال تعليق فارغ.', true); return; }

            try {
                const { data: profile, error: profileError } = await _supabase.from('profiles').select('full_name')
                                                                .eq('id', currentUser.id).single();
                if (profileError || !profile) throw (profileError || new Error("Profile not found for commenter."));

                const { error: insertError } = await _supabase.from('event_comments').insert({
                    event_id: eventId, user_id: currentUser.id, commenter_name: profile.full_name,
                    commenter_email: currentUser.email, comment_text: commentText
                });
                if (insertError) throw insertError;

                showModalMessage('تم إضافة التعليق بنجاح!');
                commentTextElement.value = ''; 
                toggleQuickComment(eventId); 
                await fetchEventCounts(eventId); 
                await fetchEventCounts(eventId, true); 
            } catch (error) {
                showModalMessage(`فشل إضافة التعليق: ${error.message}`, true);
                console.error("Quick comment error:", error);
            }
        }

        async function loadEvents() {
            if (!upcomingEventsList || !pastEventsList) { console.error("Event list containers not found"); return; }
            upcomingEventsList.innerHTML = '<div class="text-center p-4 text-gray-500 col-span-full">جاري تحميل الفعاليات القادمة...</div>';
            pastEventsList.innerHTML = '<div class="text-center p-4 text-gray-500 col-span-full">جاري تحميل الفعاليات السابقة...</div>';
            try {
                const { data: events, error } = await _supabase.from('project_events').select('*').order('event_date', { ascending: false });
                if (error) throw error;
                const today = new Date().toISOString().split('T')[0]; 
                const upcoming = events.filter(e => e.event_date >= today);
                const past = events.filter(e => e.event_date < today);
                upcomingEventsList.innerHTML = upcoming.length ? upcoming.map(e => createEventCard(e, true)).join('') : '<p class="text-gray-600 p-4 text-center col-span-full">لا توجد فعاليات قادمة حالياً.</p>';
                pastEventsList.innerHTML = past.length ? past.map(e => createEventCard(e, false)).join('') : '<p class="text-gray-600 p-4 text-center col-span-full">لا توجد فعاليات سابقة.</p>';
                attachDynamicEventListeners();
            } catch (error) {
                console.error('Error in loadEvents:', error);
                upcomingEventsList.innerHTML = '<p class="text-red-500 p-4 text-center col-span-full">فشل تحميل الفعاليات القادمة.</p>';
                pastEventsList.innerHTML = '<p class="text-red-500 p-4 text-center col-span-full">فشل تحميل الفعاليات السابقة.</p>';
                showModalMessage(`فشل تحميل الفعاليات: ${error.message}`, true);
            }
        }
        
        async function loadEventDetails(eventData) {
            if (!eventDetailsContent || !eventDetailsMainImage || !eventDetailsGallery) { 
                console.error("Event details display elements not found"); 
                if(eventDetailsContent) eventDetailsContent.innerHTML = '<p class="text-red-500 p-4 text-center">خطأ في عرض تفاصيل الفعالية (عناصر مفقودة).</p>';
                return; 
            }
            eventDetailsContent.innerHTML = ''; 
            eventDetailsMainImage.src = 'https://placehold.co/800x400/cccccc/969696?text=Loading...';
            eventDetailsMainImage.alt = 'جاري تحميل الصورة الرئيسية...';
            eventDetailsGallery.innerHTML = '';
            
            const breadcrumbContainer = document.createElement('div');
            breadcrumbContainer.className = 'flex flex-wrap gap-2 p-4';
            breadcrumbContainer.innerHTML = `
                <a href="#" class="nav-link text-[#4e7097] text-base font-medium leading-normal" data-target="events">الفعاليات</a>
                <span class="text-[#4e7097] text-base font-medium leading-normal">/</span>
                <span id="event-details-breadcrumb-title" class="text-[#0e141b] text-base font-medium leading-normal">${eventData.title || 'تفاصيل الفعالية'}</span>
            `;
            eventDetailsContent.appendChild(breadcrumbContainer);
            eventDetailsContent.appendChild(eventDetailsMainImage); 
            eventDetailsContent.appendChild(eventDetailsGallery); 

            const detailsTextContainer = document.createElement('div'); 
            detailsTextContainer.id = "event-details-text-content"; 
            detailsTextContainer.innerHTML = '<div class="text-center p-4 text-gray-500">جاري تحميل تفاصيل الفعالية...</div>';
            eventDetailsContent.appendChild(detailsTextContainer);


            try {
                document.getElementById('event-details-breadcrumb-title').textContent = eventData.title;
                const eventDateFormatted = new Date(eventData.event_date).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                const currentImageUrls = Array.isArray(eventData.image_urls) ? eventData.image_urls : (eventData.image_urls ? [eventData.image_urls] : []);
                eventDetailsMainImage.src = eventData.main_image_url || (currentImageUrls.length > 0 ? currentImageUrls[0] : 'https://placehold.co/800x400/64748B/E0E7FF?text=Event+Image');
                eventDetailsMainImage.alt = eventData.title;

                eventDetailsGallery.innerHTML = ''; 
                if (currentImageUrls.length > 0) {
                    currentImageUrls.forEach(url => {
                        const thumb = document.createElement('img');
                        thumb.src = url;
                        thumb.alt = 'صورة مصغرة للفعالية';
                        thumb.className = 'event-gallery-image';
                        if (url === eventDetailsMainImage.src) {
                            thumb.classList.add('active-gallery-thumb');
                        }
                        thumb.onclick = () => {
                            eventDetailsMainImage.src = url;
                            document.querySelectorAll('.event-gallery-image').forEach(t => t.classList.remove('active-gallery-thumb'));
                            thumb.classList.add('active-gallery-thumb');
                        };
                        eventDetailsGallery.appendChild(thumb);
                    });
                }


                const reactionTypes = [
                    { type: 'like', emoji: '👍', label: 'أعجبني' }, { type: 'love', emoji: '❤️', label: 'أحببته' },
                    { type: 'sad', emoji: '😢', label: 'أحزنني' }
                ];
                let reactionButtonsHTML = reactionTypes.map(rt => `
                    <button class="reaction-btn p-1 rounded-full hover:bg-gray-200 focus:outline-none" data-eventid="${eventData.id}" data-reactiontype="${rt.type}" aria-label="${rt.label}">
                        <span id="${rt.type}-icon-details-${eventData.id}" class="text-xl">${rt.emoji}</span>
                    </button>
                    <span id="${rt.type}-count-details-${eventData.id}" class="text-xs text-slate-500 mr-1">0</span>
                `).join('');
                
                let ownerControlsHTML = '';
                if (currentUser && currentUser.id === eventData.user_id) {
                    ownerControlsHTML = `
                        <div class="mt-4 flex gap-2">
                            <button class="edit-event-btn text-sm bg-yellow-400 hover:bg-yellow-500 text-black font-semibold py-2 px-4 rounded" data-eventid="${eventData.id}">تعديل الفعالية</button>
                            <button class="delete-event-btn text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded" data-eventid="${eventData.id}" data-imageurls='${JSON.stringify(eventData.image_urls || [])}'>حذف الفعالية</button>
                        </div>`;
                }

                detailsTextContainer.innerHTML = `
                    <h1 class="text-[#0e141b] tracking-light text-[32px] font-bold leading-tight mb-2">${eventData.title}</h1>
                    <p class="text-slate-500 text-sm mb-4">تاريخ النشر: ${new Date(eventData.created_at).toLocaleDateString('ar-EG')} | تاريخ الفعالية: ${eventDateFormatted}</p>
                    <p class="text-[#0e141b] text-base leading-relaxed whitespace-pre-wrap">${eventData.description || 'لا يوجد وصف تفصيلي لهذه الفعالية.'}</p>
                     <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">التفاعلات:</h3>
                        <div class="flex items-center gap-2 text-slate-500 text-xs"> ${reactionButtonsHTML} </div>
                    </div>
                    ${ownerControlsHTML}`;

                await fetchEventCounts(eventData.id, true); 
                await checkUserReaction(eventData.id, true);
                attachDynamicEventListenersForDetails(detailsTextContainer); 
                await loadEventComments(eventData.id); 
            } catch (error) {
                console.error('Error in loadEventDetails:', error);
                detailsTextContainer.innerHTML = '<p class="text-red-500 p-4 text-center">فشل تحميل تفاصيل الفعالية.</p>';
                showModalMessage(`فشل تحميل تفاصيل الفعالية: ${error.message}`, true);
            }
        }

        async function loadEventComments(eventId) {
            if (!eventCommentsList) { console.error("Event comments list container not found"); return; }
            eventCommentsList.innerHTML = '<div class="text-center p-4 text-gray-500">جاري تحميل التعليقات...</div>';
            try {
                const { data: commentsData, error: commentsError } = await _supabase
                    .from('event_comments')
                    .select('*') 
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });

                if (commentsError) throw commentsError;

                if (commentsData && commentsData.length > 0) {
                    const commentsWithProfileInfo = await Promise.all(
                        commentsData.map(async (comment) => {
                            let commenterProfile = { avatar_url: null, full_name: null }; 
                            if (comment.user_id) { 
                                const { data: profileData, error: profileError } = await _supabase
                                    .from('profiles')
                                    .select('avatar_url, full_name')
                                    .eq('id', comment.user_id)
                                    .single();
                                if (profileError) {
                                    console.warn(`Could not fetch profile for user_id ${comment.user_id} (comment_id: ${comment.id}):`, profileError.message);
                                } else if (profileData) {
                                    commenterProfile = profileData;
                                }
                            }
                            return { ...comment, commenter_profile: commenterProfile }; 
                        })
                    );

                    eventCommentsList.innerHTML = commentsWithProfileInfo.map(comment => {
                        const commenterName = comment.commenter_profile?.full_name || comment.commenter_name || 'مستخدم غير معروف';
                        const commenterAvatarUrl = comment.commenter_profile?.avatar_url || 'https://placehold.co/40x40/E0E0E0/B0B0B0?text=?';
                        const commentDate = new Date(comment.created_at).toLocaleString('ar-EG', {dateStyle: 'medium', timeStyle: 'short'});
                        
                        let commentOwnerControls = '';
                        if (currentUser && currentUser.id === comment.user_id) {
                            commentOwnerControls = `
                                <div class="comment-actions text-xs mt-1">
                                    <button class="edit-comment-btn text-blue-500 hover:text-blue-700" data-commentid="${comment.id}" data-eventid="${eventId}">تعديل</button>
                                    <button class="delete-comment-btn text-red-500 hover:text-red-700" data-commentid="${comment.id}" data-eventid="${eventId}">حذف</button>
                                </div>`;
                        }

                        return `
                            <div class="flex items-start gap-3 p-3 border-b border-gray-200 last:border-b-0" id="comment-item-${comment.id}">
                                <img src="${commenterAvatarUrl}" alt="${commenterName}" class="size-10 rounded-full shrink-0 object-cover">
                                <div class="flex-1">
                                    <div class="flex items-baseline gap-2">
                                        <p class="text-[#0e141b] text-sm font-bold">${commenterName}</p>
                                        <p class="text-[#4e7097] text-xs">${commentDate}</p>
                                    </div>
                                    <p class="comment-text-display text-[#0e141b] text-sm mt-1 whitespace-pre-wrap">${comment.comment_text}</p>
                                    <div class="edit-comment-area hidden-section mt-1">
                                        <textarea class="form-input w-full p-2 border rounded-md text-sm" rows="2">${comment.comment_text}</textarea>
                                        <div class="mt-1 flex gap-2">
                                            <button class="save-edit-comment-btn text-xs bg-green-500 text-white py-1 px-2 rounded hover:bg-green-600" data-commentid="${comment.id}" data-eventid="${eventId}">حفظ</button>
                                            <button class="cancel-edit-comment-btn text-xs bg-gray-300 text-gray-700 py-1 px-2 rounded hover:bg-gray-400" data-commentid="${comment.id}">إلغاء</button>
                                        </div>
                                    </div>
                                    ${commentOwnerControls}
                                </div>
                            </div>`;
                    }).join('');
                    attachCommentActionListeners(eventCommentsList);
                } else {
                    eventCommentsList.innerHTML = '<p class="text-gray-500 p-4 text-center">لا توجد تعليقات حتى الآن. كن أول من يعلق!</p>';
                }
            } catch (error) {
                console.error('Error in loadEventComments:', error); 
                eventCommentsList.innerHTML = '<p class="text-red-500 p-4 text-center">فشل تحميل التعليقات.</p>';
                showModalMessage(`فشل تحميل التعليقات: ${error.message}`, true);
            }
        }


        function handleEditCommentClick(e) {
            const commentId = e.currentTarget.dataset.commentid;
            const commentItem = document.getElementById(`comment-item-${commentId}`);
            if (commentItem) {
                commentItem.querySelector('.comment-text-display').classList.add('hidden-section');
                commentItem.querySelector('.comment-actions').classList.add('hidden-section');
                commentItem.querySelector('.edit-comment-area').classList.remove('hidden-section');
            }
        }
        function handleCancelEditCommentClick(e) {
            const commentId = e.currentTarget.dataset.commentid;
            const commentItem = document.getElementById(`comment-item-${commentId}`);
            if (commentItem) {
                commentItem.querySelector('.comment-text-display').classList.remove('hidden-section');
                commentItem.querySelector('.comment-actions').classList.remove('hidden-section');
                commentItem.querySelector('.edit-comment-area').classList.add('hidden-section');
            }
        }
        async function handleSaveEditCommentClick(e) {
            const commentId = e.currentTarget.dataset.commentid;
            const eventId = e.currentTarget.dataset.eventid;
            const commentItem = document.getElementById(`comment-item-${commentId}`);
            if (!commentItem || !currentUser) return;
            const newText = commentItem.querySelector('.edit-comment-area textarea').value;
            if (!newText.trim()) { showModalMessage('لا يمكن حفظ تعليق فارغ.', true); return; }

            try {
                const { error } = await _supabase.from('event_comments')
                    .update({ comment_text: newText, updated_at: new Date().toISOString() }) 
                    .eq('id', commentId).eq('user_id', currentUser.id);
                if (error) throw error;
                showModalMessage('تم تعديل التعليق بنجاح.');
                await loadEventComments(eventId); 
            } catch (error) {
                showModalMessage(`فشل تعديل التعليق: ${error.message}`, true);
                console.error("Save edit comment error:", error);
            }
        }
        async function handleDeleteCommentClick(e) {
            const commentId = e.currentTarget.dataset.commentid;
            const eventId = e.currentTarget.dataset.eventid;
            if (!currentUser) return;
            showConfirmModal('هل أنت متأكد أنك تريد حذف هذا التعليق؟', async () => {
                try {
                    const { error } = await _supabase.from('event_comments').delete()
                                        .eq('id', commentId).eq('user_id', currentUser.id);
                    if (error) throw error;
                    showModalMessage('تم حذف التعليق بنجاح.');
                    await loadEventComments(eventId); 
                    await fetchEventCounts(eventId, true); 
                    await fetchEventCounts(eventId, false);
                } catch (error) {
                    showModalMessage(`فشل حذف التعليق: ${error.message}`, true);
                    console.error("Delete comment error:", error);
                }
            });
        }
        
        addCommentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showModalMessage('يجب تسجيل الدخول للتعليق.', true); navigateTo('login'); return; }
            if (!currentEventId) { showModalMessage('لم يتم تحديد فعالية للتعليق عليها.', true); return; }
            const commentText = document.getElementById('comment-text').value;
            if (!commentText.trim()) { showModalMessage('لا يمكن إرسال تعليق فارغ.', true); return; }

            try {
                const { data: profile, error: profileError } = await _supabase.from('profiles')
                    .select('full_name').eq('id', currentUser.id).single();
                if (profileError || !profile) throw (profileError || new Error("Profile not found for commenter."));
                
                const { error } = await _supabase.from('event_comments').insert({
                    event_id: currentEventId, user_id: currentUser.id, commenter_name: profile.full_name, 
                    commenter_email: currentUser.email, comment_text: commentText
                });
                if (error) throw error;

                showModalMessage('تم إضافة التعليق بنجاح!');
                document.getElementById('comment-text').value = ''; 
                await loadEventComments(currentEventId); 
                await fetchEventCounts(currentEventId, true); 
                await fetchEventCounts(currentEventId, false); 
            } catch (error) {
                showModalMessage(`فشل إضافة التعليق: ${error.message}`, true);
                console.error("Add comment error:", error);
            }
        });

        // Define wrapper functions before they are used in attachDynamicEventListeners
        function handleEditEventClick(e) {
            handleEditEvent(e.currentTarget.dataset.eventid);
        }
        function handleDeleteEventClick(e) {
            handleDeleteEvent(e.currentTarget.dataset.eventid, e.currentTarget.dataset.imageurls);
        }
        function handleReactionEvent(e) { handleReaction(e.currentTarget.dataset.eventid, e.currentTarget.dataset.reactiontype, false); }
        function handleReactionEventFromDetails(e) { handleReaction(e.currentTarget.dataset.eventid, e.currentTarget.dataset.reactiontype, true); }
        function handleToggleCommentEvent(e) { toggleQuickComment(e.currentTarget.dataset.eventid); }
        function handlePostQuickCommentEvent(e) { postQuickComment(e.currentTarget.dataset.eventid); }


        function attachDynamicEventListeners() {
            document.querySelectorAll('.reaction-btn').forEach(button => {
                button.removeEventListener('click', handleReactionEvent); 
                button.addEventListener('click', handleReactionEvent);
            });
            document.querySelectorAll('.toggle-comment-btn').forEach(button => {
                button.removeEventListener('click', handleToggleCommentEvent);
                button.addEventListener('click', handleToggleCommentEvent);
            });
            document.querySelectorAll('.post-quick-comment-btn').forEach(button => {
                button.removeEventListener('click', handlePostQuickCommentEvent);
                button.addEventListener('click', handlePostQuickCommentEvent);
            });
            document.querySelectorAll('.edit-event-btn').forEach(button => {
                button.removeEventListener('click', handleEditEventClick);
                button.addEventListener('click', handleEditEventClick);
            });
            document.querySelectorAll('.delete-event-btn').forEach(button => {
                button.removeEventListener('click', handleDeleteEventClick);
                button.addEventListener('click', handleDeleteEventClick);
            });
             document.querySelectorAll('.event-details-link').forEach(link => { 
                link.removeEventListener('click', handleEventDetailsLinkClick);
                link.addEventListener('click', handleEventDetailsLinkClick);
            });
        }
        
        async function handleEventDetailsLinkClick(e) {
            e.preventDefault();
            const eventId = e.currentTarget.dataset.eventid;
            try {
                const { data: eventData, error: fetchError } = await _supabase.from('project_events')
                    .select('*').eq('id', eventId).single();
                if (fetchError) throw fetchError;
                if (eventData) navigateTo('event-details', eventData);
                else showModalMessage('لم يتم العثور على الفعالية.', true);
            } catch (error) {
                showModalMessage(`فشل تحميل تفاصيل الفعالية: ${error.message}`, true);
                console.error("Event details link click error:", error);
            }
        }

        function attachDynamicEventListenersForDetails(containerElement) {
             // Ensure containerElement is valid before querying
            if (!containerElement || typeof containerElement.querySelectorAll !== 'function') {
                console.warn("Invalid containerElement for attachDynamicEventListenersForDetails:", containerElement);
                return;
            }
            containerElement.querySelectorAll('.reaction-btn').forEach(button => {
                button.removeEventListener('click', handleReactionEventFromDetails);
                button.addEventListener('click', handleReactionEventFromDetails);
            });
             containerElement.querySelectorAll('.edit-event-btn').forEach(button => {
                button.removeEventListener('click', handleEditEventClick);
                button.addEventListener('click', handleEditEventClick);
            });
            containerElement.querySelectorAll('.delete-event-btn').forEach(button => {
                button.removeEventListener('click', handleDeleteEventClick);
                button.addEventListener('click', handleDeleteEventClick);
            });
        }
        function attachCommentActionListeners(containerElement) {
            containerElement.querySelectorAll('.edit-comment-btn').forEach(btn => {
                 btn.removeEventListener('click', handleEditCommentClick); btn.addEventListener('click', handleEditCommentClick);
            });
            containerElement.querySelectorAll('.delete-comment-btn').forEach(btn => {
                btn.removeEventListener('click', handleDeleteCommentClick); btn.addEventListener('click', handleDeleteCommentClick);
            });
            containerElement.querySelectorAll('.save-edit-comment-btn').forEach(btn => {
                btn.removeEventListener('click', handleSaveEditCommentClick); btn.addEventListener('click', handleSaveEditCommentClick);
            });
            containerElement.querySelectorAll('.cancel-edit-comment-btn').forEach(btn => {
                btn.removeEventListener('click', handleCancelEditCommentClick); btn.addEventListener('click', handleCancelEditCommentClick);
            });
        }

        async function handleEditEvent(eventId) { 
            if (!currentUser) { showModalMessage('يجب تسجيل الدخول لتعديل الفعالية.', true); navigateTo('login'); return; }
            editingEventId = eventId;
            eventImageFilesToUpload = []; 
            // existingEventImageUrls = []; // This was the issue, should be correctly populated below
            selectedMainImagePreviewUrl = null;

            try {
                const { data: eventToEdit, error } = await _supabase.from('project_events').select('*')
                    .eq('id', eventId).eq('user_id', currentUser.id).single();
                if (error || !eventToEdit) throw (error || new Error("Event not found or not authorized to edit."));

                document.getElementById('event-form-title').textContent = 'تعديل الفعالية';
                document.getElementById('submit-event-form-btn').textContent = 'تحديث الفعالية';
                document.getElementById('event-title').value = eventToEdit.title;
                document.getElementById('event-description').value = eventToEdit.description;
                document.getElementById('event-date').value = eventToEdit.event_date;
                
                // Ensure existingEventImageUrls is an array, even if image_urls is null or not an array
                existingEventImageUrls = Array.isArray(eventToEdit.image_urls) ? eventToEdit.image_urls : (eventToEdit.image_urls ? [eventToEdit.image_urls] : []);
                
                selectedMainImagePreviewUrl = eventToEdit.main_image_url || (existingEventImageUrls.length > 0 ? existingEventImageUrls[0] : null);
                
                eventImageFilesInput.value = ''; 
                renderImagePreviews(); 

                createEventFormContainer.classList.remove('hidden-section');
                createEventBtnGeneral.classList.add('hidden-section');
                if(!document.getElementById('events').classList.contains('hidden-section')) {
                     createEventFormContainer.scrollIntoView({ behavior: 'smooth' });
                } else {
                    navigateTo('events'); 
                    setTimeout(() => createEventFormContainer.scrollIntoView({ behavior: 'smooth' }), 100);
                }
            } catch (error) {
                showModalMessage(`فشل تحميل بيانات الفعالية للتعديل: ${error.message}`, true);
                editingEventId = null;
                console.error("Edit event load error:", error);
            }
        }

        async function handleDeleteEvent(eventId, imageurlsJson) {
            if (!currentUser) { showModalMessage('يجب تسجيل الدخول لحذف الفعالية.', true); navigateTo('login'); return; }
            
            let imageUrlsToDelete = [];
            try {
                imageUrlsToDelete = JSON.parse(imageurlsJson || '[]');
            } catch (e) {
                console.error("Error parsing image URLs for deletion:", e);
            }

            showConfirmModal('هل أنت متأكد أنك تريد حذف هذه الفعالية وجميع صورها؟ هذا الإجراء لا يمكن التراجع عنه.', async () => {
                try {
                    await _supabase.from('event_comments').delete().eq('event_id', eventId); 
                    await _supabase.from('event_reactions').delete().eq('event_id', eventId); 

                    if (imageUrlsToDelete && Array.isArray(imageUrlsToDelete) && imageUrlsToDelete.length > 0) { // Ensure it's an array
                        const fileNamesToDelete = imageUrlsToDelete.map(url => url.substring(url.lastIndexOf('/') + 1)).filter(name => name);
                        if (fileNamesToDelete.length > 0) {
                            const { error: storageError } = await _supabase.storage.from('events-images').remove(fileNamesToDelete);
                            if (storageError) console.warn("Could not delete some event images from storage:", storageError.message);
                        }
                    }
                    const { error: eventDeleteError } = await _supabase.from('project_events').delete()
                        .eq('id', eventId).eq('user_id', currentUser.id); 
                    if (eventDeleteError) throw eventDeleteError;

                    showModalMessage('تم حذف الفعالية بنجاح.');
                    await loadEvents(); 
                    if (!document.getElementById('event-details').classList.contains('hidden-section') && currentEventId === eventId) {
                        navigateTo('events');
                    }
                } catch (error) {
                     showModalMessage(`فشل حذف الفعالية: ${error.message}`, true);
                     console.error("Detailed error during event deletion:", error);
                }
            });
        }

        const themeToggleButton = document.getElementById('theme-toggle-button');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');

        function applyTheme() {
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                document.documentElement.classList.add('dark');
                darkIcon.classList.remove('hidden-section');
                lightIcon.classList.add('hidden-section');
            } else { 
                document.documentElement.classList.remove('dark');
                lightIcon.classList.remove('hidden-section');
                darkIcon.classList.add('hidden-section');
            }
        }
        
        if (themeToggleButton && darkIcon && lightIcon) {
            themeToggleButton.addEventListener('click', () => {
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'light' : 'dark');
                applyTheme();
            });
        }

        function initializeApp() {
            applyTheme(); 
            console.log("App initialized. Waiting for onAuthStateChange.");
        }

        initializeApp();

    </script>
</body>
</html>
